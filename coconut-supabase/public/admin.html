<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Penjual - Bumi Jelly D'Hasna</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        :root {
            --primary: #0f7a63;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text-main); }
        
        .dashboard-container {
            max-width: 1800px; /* Angka diperbesar agar bisa melebar di layar PC/Laptop yang lebar */
            width: 100%; 
            margin: 0 auto; 
            padding: 20px 2%; /* Menggunakan 2% agar margin kiri & kanan selalu tipis dan proporsional di PC */
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) { .dashboard-container { width: 95%; } }

        /* HEADER SECTION */
        .header {
            background: var(--primary); color: white; padding: 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(15, 122, 99, 0.2);
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 800; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .refresh-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; gap: 8px; align-items: center; transition: 0.3s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.4); }

        /* CARDS & CHARTS */
        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-light); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        .stat-label { font-size: 13px; color: var(--text-light); }
        .charts-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* TABLE */
        .grouping-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #e5e7eb; padding: 8px 16px; border-radius: 50px; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .order-group { margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
        .group-header { background: #f9fafb; padding: 15px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .group-title { font-weight: 700; color: var(--primary); font-size: 14px; }
        .order-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .order-table th { text-align: left; padding: 12px 20px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #eee; }
        .order-table td { padding: 12px 20px; border-bottom: 1px solid #f3f4f6; color: #333; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-qris { background: #dbeafe; color: #1e40af; }
        .badge-cash { background: #d1fae5; color: #065f46; }
        #loading { text-align: center; padding: 50px; color: var(--text-light); }

        /* MODAL COMPACT STYLE */
        .modal-overlay { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); align-items:center; justify-content:center; 
            z-index:9999; backdrop-filter: blur(4px); 
        }
        .modal-box { 
            background:white; padding:25px; border-radius:16px; width:95%; max-width:500px; 
            box-shadow:0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; 
            animation: modalPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .settings-label { font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 4px; display: block; text-transform: uppercase; }
        .input-group-merged { display: flex; width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: #fff; box-sizing: border-box; }
        .input-group-merged input { flex: 1; min-width: 0; border: none !important; padding: 10px; font-size: 13px; outline: none; }
        .input-group-merged select { width: 60px; flex-shrink: 0; border: none !important; border-left: 1px solid #f3f4f6 !important; background: #f9fafb; font-weight: 700; color: var(--primary); text-align: center; font-size: 12px; cursor: pointer; outline: none; }
        .shipping-rules-box { border: 1px dashed #d1d5db; padding: 12px; border-radius: 10px; background: #fdfdfd; margin-bottom: 15px; }

        /* SUCCESS TOAST */
        .success-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: white; padding: 12px 25px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            display: flex; align-items: center; gap: 12px; z-index: 10000;
            border: 2px solid #10b981; opacity: 0; transition: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .success-toast.active { transform: translateX(-50%) translateY(0); opacity: 1; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        @media (max-width: 640px) {
            .dashboard-container {
                padding: 15px 16px; 
            }
            .header { flex-direction: column; text-align: center; gap: 15px; padding: 20px 15px; }
            .btn-group { display: flex; flex-direction: column; width: 100%; gap: 10px; }
            .refresh-btn { width: 100%; justify-content: center; padding: 12px; font-size: 14px; }

            /* Baris ini memaksa kotak statistik menjadi 1 susun ke bawah di layar HP */
            .stats-grid { grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px; }

            .charts-wrapper { grid-template-columns: 1fr; }
        }

        /* Container utama aturan */
        .rule-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            /* PENTING: Padding kanan dibuat 35px agar ada ruang kosong khusus untuk tombol X */
            padding: 12px 35px 12px 12px; 
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        /* Label kecil di dalam kotak aturan */
        .rule-sub-label {
            font-size: 10px;
            font-weight: 700;
            color: #6b7280;
            margin-bottom: 4px;
            display: block;
        }

        /* Tombol Hapus: Dimasukkan ke DALAM kotak agar tidak terpotong */
        .btn-delete-rule {
            position: absolute;
            top: 10px;    /* Nilai Positif (Masuk ke dalam) */
            right: 10px;  /* Nilai Positif (Masuk ke dalam) */
            background: #fee2e2;
            color: #ef4444;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-delete-rule:hover { 
            background: #ef4444; 
            color: white; 
        }

        /* --- Kustomisasi Modal Konfirmasi Hapus --- */
        .pulse-icon-container {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto 15px; /* Rata tengah */
            background: #fee2e2; /* Merah sangat muda */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pulse-danger-ring {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            border: 2px solid #ef4444; /* Merah Danger */
            animation: pulse-red-anim 1.5s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        @keyframes pulse-red-anim {
            0% { transform: scale(0.95); opacity: 1; }
            100% { transform: scale(1.6); opacity: 0; }
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <div>
            <h1>Dashboard Penjual</h1>
            <div style="font-size:13px; opacity:0.9;">Analisis & Pengelompokan Pesanan</div>
        </div>
        <div class="btn-group">
            <button class="refresh-btn" onclick="openTextSettings()"><i data-lucide="message-square-text"></i> Ket. Diskon</button>

            <button class="refresh-btn" onclick="openSettings()"><i data-lucide="settings"></i> Atur Toko</button>
            <button class="refresh-btn" onclick="fetchData()"><i data-lucide="refresh-cw"></i> Refresh</button>
            <button class="refresh-btn" onclick="logout()" style="background:#ef4444;"><i data-lucide="log-out"></i> Keluar</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <div class="card-title"><i data-lucide="dollar-sign"></i> Total Pendapatan</div>
            <div class="stat-value" id="stat-revenue">Rp 0</div>
            <div class="stat-label">Semua pesanan masuk</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="shopping-bag"></i> Total Pesanan</div>
            <div class="stat-value" id="stat-count">0</div>
            <div class="stat-label">Transaksi berhasil</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="ticket"></i> Voucher Dipakai</div>
            <div class="stat-value" id="stat-voucher">0%</div>
            <div class="stat-label">Persentase penggunaan</div>
        </div>
    </div>

    <div class="charts-wrapper">
        <div class="card">
            <div class="card-title">üèÜ Top Pelanggan</div>
            <div class="chart-container"><canvas id="chartCustomer"></canvas></div>
        </div>
        <div class="card">
            <div class="card-title">üìç Sebaran Wilayah</div>
            <div class="chart-container"><canvas id="chartArea"></canvas></div>
        </div>
    </div>
    <div class="charts-wrapper">
         <div class="card">
            <div class="card-title">üí∞ Metode Pembayaran</div>
            <div class="chart-container"><canvas id="chartPayment"></canvas></div>
        </div>
        <div class="card">
             <div class="card-title">üìâ Efektivitas Promo</div>
            <div class="chart-container"><canvas id="chartDiscount"></canvas></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i data-lucide="truck"></i> Pengiriman</div>
        <div class="grouping-controls">
            <button class="filter-btn active" onclick="setGrouping('route')">Rute Satu Arah</button>
            <button class="filter-btn" onclick="setGrouping('latest')">Terbaru</button>
            <button class="filter-btn" onclick="setGrouping('area')">Radius Dekat</button>
        </div>
        <div id="orders-container">
            <div id="loading">Mengambil data dari Supabase...</div>
        </div>
    </div>
</div>

<div id="successToast" class="success-toast">
    <div style="background:#10b981; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;"><i data-lucide="check" size="16"></i></div>
    <div class="toast-text">Pengaturan Toko Berhasil Diupdate!</div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f3f4f6; padding-bottom:10px;">
            <h3 style="margin:0; color:var(--primary); font-size:16px; font-weight:800;">‚öôÔ∏è Pengaturan Toko</h3>
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="background:none; border:none; color:#999; cursor:pointer;"><i data-lucide="x" size="20"></i></button>
        </div>

        <div style="margin-bottom:15px;">
            <label class="settings-label">üì¢ Teks Promo Berjalan</label>
            <input type="text" id="set_promo" style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; box-sizing:border-box;">
        </div>

        <div class="shipping-rules-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label class="settings-label" style="margin:0; color:var(--primary);">üöö Aturan Diskon Ongkir</label>
                <button onclick="addRule()" style="background:var(--primary); color:white; border:none; padding:4px 10px; border-radius:6px; font-size:11px; cursor:pointer;">+ Tambah</button>
            </div>
            <div id="rules-container" style="max-height: 120px; overflow-y: auto; font-size:12px;"></div>
        </div>

        <div style="margin-bottom:15px; background: #fff4f4; padding: 10px; border-radius: 8px; border: 1px dashed #fca5a5;">
            <label class="settings-label" style="color: #ef4444;">üö´ Batas Maksimal Pengiriman (KM)</label>
            <input type="number" id="set_max_jarak" placeholder="Contoh: 25" style="width:100%; padding:8px 12px; border:1px solid #fecaca; border-radius:6px; font-size:13px; outline:none; box-sizing:border-box;">
        </div>

        <div style="border: 1px dashed #d1d5db; padding: 12px; border-radius: 10px; margin-bottom: 15px; background: #fdfdfd;">
             <label class="settings-label" style="color:var(--primary);">üì¶ Pengaturan Diskon Barang</label>
             <div class="input-group-merged" style="margin-bottom: 10px;">
                <input type="number" id="set_barang" placeholder="Nilai Diskon" min="0">
                <select id="type_barang"><option value="nominal">Rp</option><option value="persen">%</option></select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                <div>
                    <label style="font-size:9px; font-weight:bold; color:#666;">MIN. BELI (Butir)</label>
                    <input type="number" id="set_syarat_qty_barang" placeholder="0 = Bebas" min="0" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                </div>
                <div>
                    <label style="font-size:9px; font-weight:bold; color:#666;">MIN. JARAK (KM)</label>
                    <input type="number" id="set_syarat_jarak_barang" placeholder="0 = Bebas" min="0" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                </div>
                <div>
                    <label style="font-size:9px; font-weight:bold; color:#666;">KUOTA (Orang)</label>
                    <input type="number" id="set_kuota_barang" placeholder="0 = Unlimited" min="0" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                </div>
            </div>
            <div style="font-size:10px; color:#999; margin-top:5px; text-align:right;">
                Terpakai: <b id="view_used_barang" style="color:var(--danger);">0</b>
            </div>

            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee;">
                <label style="font-size:9px; font-weight:bold; color:#0f7a63;">BERLAKU KELIPATAN? (Butir)</label>
                <input type="number" id="set_kelipatan_barang" placeholder="Isi 5 jika tiap kelipatan 5. Isi 0 jika tidak." min="0" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
            </div>
            
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
                <label class="settings-label">üéüÔ∏è Kode Voucher</label>
                <input type="text" id="set_v_code" style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; font-weight:700; text-transform:uppercase;">
            </div>
            <div>
                <label class="settings-label">üí∞ Nilai Potongan</label>
                <div class="input-group-merged">
                    <input type="number" id="set_v_val" min="0">
                    <select id="type_voucher"><option value="nominal">Rp</option><option value="persen">%</option></select>
                </div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div>
                <label style="font-size:9px; font-weight:bold; color:#666;">SYARAT MIN. BELI (Butir)</label>
                <input type="number" id="set_v_min_qty" placeholder="0 = Bebas" min="0" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
            </div>
            <div>
                <label style="font-size:9px; font-weight:bold; color:#666;">SYARAT MAKS. JARAK (KM)</label>
                <input type="number" id="set_v_max_jarak" placeholder="0 = Bebas" min="0" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
            </div>
        </div>

        <div style="background:#f9fafb; padding:12px; border-radius:10px; margin-bottom:20px;">
            <label class="settings-label">üìä Batas Kuota Voucher</label>
            <div class="input-group-merged">
                <input type="number" id="set_v_limit" min="0">
                <div style="font-size:11px; color:#6b7280; display:flex; align-items:center; padding-right:10px; white-space:nowrap; border-left:1px solid #f3f4f6; margin-left:5px;">
                    Pakai: <b id="view_used" style="color:var(--primary); margin-left:4px;">0</b>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="flex:1; padding:12px; background:#f3f4f6; color:#6b7280; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Batal</button>
            <button onclick="saveSettings()" style="flex:2; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Simpan Perubahan</button>
        </div>
    </div>
</div>

<div id="textSettingsModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f3f4f6; padding-bottom:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <h3 style="margin:0; color:var(--primary); font-size:16px; font-weight:800;">üìù Keterangan Diskon</h3>
            </div>
            <button onclick="document.getElementById('textSettingsModal').style.display='none'" style="background:none; border:none; color:#999; cursor:pointer;"><i data-lucide="x" size="20"></i></button>
        </div>

        <div style="margin-bottom:15px;">
            <label class="settings-label">üöö Keterangan Teks Diskon Ongkir</label>
            <textarea id="set_ket_ongkir" rows="3" placeholder="Contoh: Nikmati gratis ongkir untuk radius di bawah 5 KM..." style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; font-family:inherit; outline:none; resize:vertical; box-sizing:border-box; color:var(--text-main);"></textarea>
            <small style="color:#9ca3af; font-size:10px;">*Teks ini akan muncul saat pembeli mengklik ikon (i) Diskon Ongkir.</small>
        </div>

        <div style="margin-bottom:20px;">
            <label class="settings-label">üì¶ Keterangan Teks Diskon Barang</label>
            <textarea id="set_ket_barang" rows="3" placeholder="Contoh: Dapatkan potongan spesial untuk setiap pembelian minimal..." style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; font-family:inherit; outline:none; resize:vertical; box-sizing:border-box; color:var(--text-main);"></textarea>
            <small style="color:#9ca3af; font-size:10px;">*Teks ini akan muncul saat pembeli mengklik ikon (i) Diskon Barang.</small>
        </div>

        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('textSettingsModal').style.display='none'" style="flex:1; padding:12px; background:#f3f4f6; color:#6b7280; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; transition:0.2s;">Batal</button>
            <button onclick="saveTextSettings(event)" style="flex:2; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; box-shadow:0 4px 10px rgba(15,122,99,0.2); transition:0.2s;">Simpan Keterangan</button>
        </div>
    </div>
</div>

<div id="deleteConfirmModal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-box" style="max-width: 340px; text-align: center; padding: 30px 25px;">
        
        <div class="pulse-icon-container">
            <div class="pulse-danger-ring"></div>
            <i data-lucide="trash-2" size="28" color="#ef4444"></i>
        </div>
        
        <h3 style="margin: 0 0 10px; color: var(--text-main); font-size: 18px; font-weight: 800;">Hapus Aturan?</h3>
        <p style="color: var(--text-light); font-size: 13px; margin: 0 0 25px; line-height: 1.5;">
            Apakah Anda yakin ingin menghapus aturan diskon ongkir ini? Tindakan ini akan hilang setelah Anda menyimpan perubahan.
        </p>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="closeDeleteModal()" style="flex: 1; padding: 12px; background: #f3f4f6; color: #6b7280; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s;">
                Batal
            </button>
            <button onclick="confirmDeleteRule()" style="flex: 1; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25); transition: 0.2s;">
                Ya, Hapus
            </button>
        </div>
    </div>
</div>


<script>
    // --- 1. CONFIG ---
    const config = {
        url: "https://iltvpnplysjeaxufiokg.supabase.co",
        anon: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU"
    };
    const db = window.supabase.createClient(config.url, config.anon);
    let allOrders = [], charts = {}, currentRules = [];

    // --- 2. AUTH ---
    async function checkAuth() {
        const { data: { session } } = await db.auth.getSession();
        if (!session) window.location.href = 'login.html';
    }
    checkAuth();

    async function logout() { await db.auth.signOut(); window.location.href = 'login.html'; }

    // --- 3. DATA ENGINE ---
    async function fetchData() {
        const container = document.getElementById('orders-container');
        container.innerHTML = '<div id="loading">Sedang menyinkronkan data...</div>';
        try {
            const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            allOrders = data;
            calculateStats();
            renderCharts();
            setGrouping('route');
            lucide.createIcons();
        } catch (e) { alert("Error: " + e.message); }
    }

    function calculateStats() {
        const rev = allOrders.reduce((a, b) => a + (b.total_bayar || 0), 0);
        document.getElementById('stat-revenue').innerText = 'Rp ' + rev.toLocaleString('id-ID');
        document.getElementById('stat-count').innerText = allOrders.length;
        const vch = (allOrders.filter(o => o.nilai_voucher > 0).length / (allOrders.length || 1) * 100).toFixed(1);
        document.getElementById('stat-voucher').innerText = vch + '%';
    }

    // --- 4. CHART ENGINE (HANDAL & OPTIMAL) ---
    function createChart(id, type, data) {
        const canvas = document.getElementById(id);
        if (!canvas) return;

        // Safety Check: Pastikan library Chart.js sudah ada
        if (typeof Chart === 'undefined') {
            canvas.parentNode.innerHTML = '<div style="font-size:12px;color:red;text-align:center;padding:20px;">Library Gagal Dimuat</div>';
            return;
        }

        if (charts[id]) charts[id].destroy(); 

        const ctx = canvas.getContext('2d');
        charts[id] = new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { boxWidth: 10, font: { size: 11 }, padding: 15 } 
                    } 
                }
            }
        });
    }

    function renderCharts() {
        // Customer loyalitas
        const counts = {};
        allOrders.forEach(o => counts[o.nama] = (counts[o.nama] || 0) + 1);
        const top = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
        createChart('chartCustomer', 'bar', {
            labels: top.map(i => i[0]),
            datasets: [{ label: 'Total Order', data: top.map(i => i[1]), backgroundColor: '#0f7a63', borderRadius: 6 }]
        });

        // Radius
        const rad = { '< 2.5 KM': 0, '> 2.5 KM': 0 };
        allOrders.forEach(o => parseFloat(o.jarak_km) <= 2.5 ? rad['< 2.5 KM']++ : rad['> 2.5 KM']++);
        createChart('chartArea', 'doughnut', {
            labels: Object.keys(rad),
            datasets: [{ data: Object.values(rad), backgroundColor: ['#10b981', '#ef4444'] }]
        });

        // Payment
        const pay = {};
        allOrders.forEach(o => pay[o.metode_bayar] = (pay[o.metode_bayar] || 0) + 1);
        createChart('chartPayment', 'pie', {
            labels: Object.keys(pay),
            datasets: [{ data: Object.values(pay), backgroundColor: ['#3b82f6', '#10b981'] }]
        });

        // Voucher Efektivitas
        const vUsed = allOrders.filter(o => o.nilai_voucher > 0).length;
        createChart('chartDiscount', 'bar', {
            labels: ['Pakai Voucher', 'Tanpa Voucher'],
            datasets: [{ data: [vUsed, allOrders.length - vUsed], backgroundColor: ['#8b5cf6', '#9ca3af'], borderRadius: 6 }]
        });
    }

    // --- 5. SETTINGS ENGINE ---
    // --- 5. SETTINGS ENGINE ---
    async function openSettings() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = 'flex';
        try {
            const { data } = await db.from('store_settings').select('*').limit(1).single();
            if (data) {
                document.getElementById('set_promo').value = data.teks_promo;
                document.getElementById('set_max_jarak').value = data.max_jarak_pengiriman || 25;
                document.getElementById('set_syarat_qty_barang').value = data.syarat_qty_diskon_barang || 0;
                document.getElementById('set_syarat_jarak_barang').value = data.syarat_jarak_diskon_barang || 0;
                document.getElementById('set_kuota_barang').value = data.kuota_diskon_barang || 0;
                document.getElementById('view_used_barang').innerText = data.terpakai_diskon_barang || 0;
                document.getElementById('set_barang').value = data.diskon_barang;
                document.getElementById('type_barang').value = data.tipe_barang || 'nominal';
                
                // KODE BARU: Load Kelipatan Diskon Barang
                document.getElementById('set_kelipatan_barang').value = data.diskon_barang_kelipatan_qty || 0;

                document.getElementById('set_v_code').value = data.voucher_kode;
                document.getElementById('set_v_val').value = data.voucher_nilai;
                document.getElementById('type_voucher').value = data.tipe_voucher || 'nominal';
                
                // KODE BARU: Load Syarat Voucher
                document.getElementById('set_v_min_qty').value = data.syarat_qty_voucher || 0;
                document.getElementById('set_v_max_jarak').value = data.syarat_max_jarak_voucher || 0;

                document.getElementById('set_v_limit').value = data.voucher_limit;
                document.getElementById('view_used').innerText = data.voucher_used;
                currentRules = data.shipping_rules || [];
                renderRules();
            }
        } catch (e) { console.error("Load failed"); }
        lucide.createIcons();
    }

    async function saveSettings() {
        const btn = event.target;
        btn.innerText = "‚è≥ Menyimpan...";
        btn.disabled = true;

        try {
            const updateData = {
                teks_promo: document.getElementById('set_promo').value,
                max_jarak_pengiriman: parseFloat(document.getElementById('set_max_jarak').value) || 0,
                syarat_qty_diskon_barang: parseInt(document.getElementById('set_syarat_qty_barang').value) || 0,
                syarat_jarak_diskon_barang: parseFloat(document.getElementById('set_syarat_jarak_barang').value) || 0,
                kuota_diskon_barang: parseInt(document.getElementById('set_kuota_barang').value) || 0,
                diskon_barang: parseInt(document.getElementById('set_barang').value) || 0,
                tipe_barang: document.getElementById('type_barang').value,
                
                // KODE BARU: Simpan Kelipatan Diskon Barang
                diskon_barang_kelipatan_qty: parseInt(document.getElementById('set_kelipatan_barang').value) || 0,

                voucher_kode: document.getElementById('set_v_code').value.toUpperCase(),
                voucher_nilai: parseInt(document.getElementById('set_v_val').value) || 0,
                tipe_voucher: document.getElementById('type_voucher').value,
                
                // KODE BARU: Simpan Syarat Voucher
                syarat_qty_voucher: parseInt(document.getElementById('set_v_min_qty').value) || 0,
                syarat_max_jarak_voucher: parseFloat(document.getElementById('set_v_max_jarak').value) || 0,

                voucher_limit: parseInt(document.getElementById('set_v_limit').value) || 0,
                shipping_rules: currentRules // Mengirim Array JSON terbaru (termasuk hasil hapus)
            };

            // Ambil ID pertama dari tabel (Mencegah error ID not found)
            const { data: check } = await db.from('store_settings').select('id').limit(1).single();
            if (!check) throw new Error("Gagal menemukan data di database.");

            const { error } = await db.from('store_settings').update(updateData).eq('id', check.id);
            
            if (error) throw error;

            // Sukses
            document.getElementById('settingsModal').style.display = 'none';
            const toast = document.getElementById('successToast');
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);

        } catch (err) {
            alert("Gagal: " + err.message);
        } finally {
            btn.innerText = "Simpan Perubahan";
            btn.disabled = false;
        }
    }
    // --- FUNGSI UNTUK MEMBUKA MODAL KETERANGAN DISKON ---
    async function openTextSettings() {
        const modal = document.getElementById('textSettingsModal');
        modal.style.display = 'flex';
        
        try {
            // Ambil data teks dari database
            const { data } = await db.from('store_settings').select('ket_diskon_ongkir, ket_diskon_barang').limit(1).single();
            if (data) {
                document.getElementById('set_ket_ongkir').value = data.ket_diskon_ongkir || '';
                document.getElementById('set_ket_barang').value = data.ket_diskon_barang || '';
            }
        } catch (e) { 
            console.error("Gagal memuat keterangan:", e); 
        }
        lucide.createIcons(); // Pastikan ikon 'x' terender
    }

    // --- FUNGSI UNTUK MENYIMPAN KETERANGAN DISKON ---
    async function saveTextSettings(event) {
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ Menyimpan...";
        btn.disabled = true;

        try {
            const updateData = {
                ket_diskon_ongkir: document.getElementById('set_ket_ongkir').value,
                ket_diskon_barang: document.getElementById('set_ket_barang').value
            };

            // Deteksi ID dinamis
            const { data: check } = await db.from('store_settings').select('id').limit(1).single();
            if (!check) throw new Error("Database kosong.");

            const { error } = await db.from('store_settings').update(updateData).eq('id', check.id);
            if (error) throw error;

            // Tutup pop-up & tampilkan notifikasi sukses
            document.getElementById('textSettingsModal').style.display = 'none';
            
            const toast = document.getElementById('successToast');
            const toastText = toast.querySelector('.toast-text');
            const defaultToastMsg = toastText.innerText; // Simpan pesan default
            
            toastText.innerText = "Keterangan Diskon Berhasil Diperbarui!";
            toast.classList.add('active');
            
            setTimeout(() => { 
                toast.classList.remove('active'); 
                setTimeout(() => toastText.innerText = defaultToastMsg, 500); // Kembalikan teks asli
            }, 3000);

        } catch (err) {
            alert("Gagal: " + err.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function renderRules() {
        const container = document.getElementById('rules-container');
        container.innerHTML = "";

        if (currentRules.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:15px; color:#9ca3af; font-size:12px; border:1px dashed #d1d5db; border-radius:8px;">Belum ada aturan diskon ongkir.</div>';
            return;
        }

        currentRules.forEach((rule, index) => {
            const div = document.createElement('div');
            div.className = 'rule-item';
            
            // Menggunakan Flexbox agar lebar inputan proporsional dan tidak kebesaran
            div.innerHTML = `
                <button type="button" class="btn-delete-rule" onclick="removeRule(${index})" title="Hapus Aturan">‚úï</button>
                
                <div style="display: flex; gap: 12px; margin-bottom: 10px; align-items: flex-end;">
                    <div style="flex: 1.5;">
                        <label class="rule-sub-label">Jarak (KM)</label>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <input type="number" value="${rule.minDist}" onchange="updateRule(${index}, 'minDist', this.value)" style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:6px; font-size:12px; outline:none; text-align:center;">
                            <span style="color:#9ca3af; font-weight:bold;">-</span>
                            <input type="number" value="${rule.maxDist}" onchange="updateRule(${index}, 'maxDist', this.value)" style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:6px; font-size:12px; outline:none; text-align:center;">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <label class="rule-sub-label">Min. Qty</label>
                        <input type="number" value="${rule.minQty}" onchange="updateRule(${index}, 'minQty', this.value)" style="width:100%; padding:6px; border:1px solid #d1d5db; border-radius:6px; font-size:12px; outline:none; text-align:center;">
                    </div>
                </div>
                
                <div>
                    <label class="rule-sub-label">Nilai Diskon</label>
                    <div class="input-group-merged" style="border-radius:6px;">
                        <input type="number" value="${rule.val}" onchange="updateRule(${index}, 'val', this.value)" style="padding:6px 10px; font-size:12px; font-weight:600;">
                        <select onchange="updateRule(${index}, 'type', this.value)" style="width:55px; font-size:12px; padding:0;">
                            <option value="nominal" ${rule.type === 'nominal' ? 'selected' : ''}>Rp</option>
                            <option value="persen" ${rule.type === 'persen' ? 'selected' : ''}>%</option>
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    let ruleIndexToDelete = null;

    // Fungsi Menghapus Aturan
    function removeRule(index) {
        ruleIndexToDelete = index; 
        document.getElementById('deleteConfirmModal').style.display = 'flex'; 
        lucide.createIcons(); 
    }
    // 2. Fungsi saat tombol 'Batal' ditekan di Pop-up
    function closeDeleteModal() {
        document.getElementById('deleteConfirmModal').style.display = 'none'; // Sembunyikan
        ruleIndexToDelete = null; // Lupakan memori
    }

    // 3. Fungsi saat tombol 'Ya, Hapus' ditekan di Pop-up
    function confirmDeleteRule() {
        if (ruleIndexToDelete !== null) {
            currentRules.splice(ruleIndexToDelete, 1); // Hapus dari memori array
            renderRules(); // Render ulang tampilannya
        }
        closeDeleteModal(); // Tutup Pop-up setelah sukses
    }

    // Fungsi Update Data (Penting agar saat diketik data tersimpan di variabel)
    function updateRule(index, field, value) {
        if (field === 'type') {
            currentRules[index][field] = value;
        } else {
            currentRules[index][field] = parseFloat(value) || 0;
        }
    }

    function addRule() {
        currentRules.push({ minDist: 0, maxDist: 5, minQty: 1, type: 'persen', val: 100 });
        renderRules();
    }

    function setGrouping(m) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`button[onclick="setGrouping('${m}')"]`);
        if(btn) btn.classList.add('active');
        const c = document.getElementById('orders-container');
        c.innerHTML = "";
        
        const sorted = m === 'route' ? [...allOrders].sort((a,b) => parseFloat(a.jarak_km)-parseFloat(b.jarak_km)) : allOrders;
        const filtered = m === 'area' ? allOrders.filter(o => parseFloat(o.jarak_km) <= 2.5) : sorted;
        
        renderGroup(m === 'area' ? "Radius Prioritas" : "Daftar Pesanan", filtered, c);
    }

    function renderGroup(t, o, c) {
        if(!o.length) { c.innerHTML = "<div id='loading'>Tidak ada data.</div>"; return; }
        let rows = o.map(i => `<tr><td><strong>${i.nama}</strong><br><small>${i.alamat}</small></td><td>${i.jarak_km}km</td><td>${i.jumlah_butir}</td><td>Rp ${i.total_bayar.toLocaleString()}</td><td><span class="status-badge ${i.metode_bayar==='QRIS'?'badge-qris':'badge-cash'}">${i.metode_bayar}</span></td></tr>`).join('');
        const g = document.createElement('div'); g.className = 'order-group';
        g.innerHTML = `<div class="group-header"><strong>${t}</strong> <span class="group-badge">${o.length} Order</span></div><div style="overflow-x:auto;"><table class="order-table"><thead><tr><th>User</th><th>Jarak</th><th>Qty</th><th>Total</th><th>Metode</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        c.appendChild(g);
    }

    document.addEventListener('DOMContentLoaded', fetchData);
</script>

</body>
</html>
