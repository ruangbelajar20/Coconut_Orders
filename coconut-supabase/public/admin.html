<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Penjual - Bumi Jelly D'Hasna</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        :root {
            --primary: #0f7a63;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text-main); }
        
        .dashboard-container {
            max-width: 1600px; width: 98%; margin: 20px auto; padding: 0 10px;
            display: grid; grid-template-columns: 1fr; gap: 20px; box-sizing: border-box;
        }
        
        /* HEADER SECTION */
        .header {
            background: var(--primary); color: white; padding: 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(15, 122, 99, 0.2);
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 800; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .refresh-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; gap: 8px; align-items: center; transition: 0.3s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.4); }

        /* CARDS & LAYOUT */
        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-light); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        .charts-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { position: relative; height: 280px; width: 100%; }

        /* TABLE & FILTERS */
        .grouping-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #e5e7eb; padding: 8px 16px; border-radius: 50px; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .order-group { margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
        .group-header { background: #f9fafb; padding: 12px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .order-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .order-table th { text-align: left; padding: 12px 20px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #eee; }
        .order-table td { padding: 12px 20px; border-bottom: 1px solid #f3f4f6; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-qris { background: #dbeafe; color: #1e40af; }
        .badge-cash { background: #d1fae5; color: #065f46; }

        /* MODAL COMPACT STYLE */
        .modal-overlay { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); align-items:center; justify-content:center; 
            z-index:9999; backdrop-filter: blur(4px); 
        }
        .modal-box { 
            background:white; padding:25px; border-radius:16px; width:95%; max-width:500px; 
            box-shadow:0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; 
            animation: modalPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .settings-label { font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 4px; display: block; text-transform: uppercase; }
        .input-group-merged { display: flex; width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: #fff; }
        .input-group-merged input { flex: 1; min-width: 0; border: none !important; padding: 10px; font-size: 13px; outline: none; }
        .input-group-merged select { width: 55px; border: none; border-left: 1px solid #f3f4f6; background: #f9fafb; font-weight: 700; color: var(--primary); text-align: center; font-size: 12px; outline: none; cursor: pointer; }
        .shipping-rules-box { border: 1px dashed #d1d5db; padding: 12px; border-radius: 10px; background: #fdfdfd; margin-bottom: 15px; }

        /* TOAST SUCCESS */
        .success-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: white; padding: 12px 25px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            display: flex; align-items: center; gap: 12px; z-index: 10000;
            border: 2px solid #10b981; opacity: 0; transition: 0.5s;
        }
        .success-toast.active { transform: translateX(-50%) translateY(0); opacity: 1; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        @media (max-width: 640px) {
            .header { flex-direction: column; text-align: center; gap: 15px; }
            .btn-group, .refresh-btn { width: 100%; justify-content: center; }
            .charts-wrapper { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <div>
            <h1>Dashboard Penjual</h1>
            <div style="font-size:13px; opacity:0.9;">Bumi Jelly D'Hasna Admin</div>
        </div>
        <div class="btn-group">
            <button class="refresh-btn" onclick="openSettings()"><i data-lucide="settings"></i> Atur Toko</button>
            <button class="refresh-btn" onclick="fetchData()"><i data-lucide="refresh-cw"></i> Refresh</button>
            <button class="refresh-btn" onclick="logout()" style="background:#ef4444;"><i data-lucide="log-out"></i> Keluar</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <div class="card-title"><i data-lucide="dollar-sign"></i> Pendapatan</div>
            <div class="stat-value" id="stat-revenue">Rp 0</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="shopping-bag"></i> Total Pesanan</div>
            <div class="stat-value" id="stat-count">0</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="ticket"></i> Efektivitas Voucher</div>
            <div class="stat-value" id="stat-voucher">0%</div>
        </div>
    </div>

    <div class="charts-wrapper">
        <div class="card">
            <div class="card-title">üèÜ Top Pelanggan</div>
            <div class="chart-container"><canvas id="chartCustomer"></canvas></div>
        </div>
        <div class="card">
            <div class="card-title">üìç Sebaran Wilayah</div>
            <div class="chart-container"><canvas id="chartArea"></canvas></div>
        </div>
    </div>
    <div class="charts-wrapper">
         <div class="card">
            <div class="card-title">üí∞ Metode Pembayaran</div>
            <div class="chart-container"><canvas id="chartPayment"></canvas></div>
        </div>
        <div class="card">
             <div class="card-title">üìâ Penggunaan Voucher</div>
            <div class="chart-container"><canvas id="chartDiscount"></canvas></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i data-lucide="truck"></i> Pengiriman</div>
        <div class="grouping-controls">
            <button class="filter-btn active" onclick="setGrouping('route')">Rute (Jarak)</button>
            <button class="filter-btn" onclick="setGrouping('latest')">Terbaru</button>
            <button class="filter-btn" onclick="setGrouping('area')">Radius < 2.5KM</button>
        </div>
        <div id="orders-container">
            <div id="loading">Memuat data...</div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f3f4f6; padding-bottom:10px;">
            <h3 style="margin:0; color:var(--primary); font-size:16px; font-weight:800;">‚öôÔ∏è Pengaturan Toko</h3>
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="background:none; border:none; color:#999; cursor:pointer;"><i data-lucide="x" size="20"></i></button>
        </div>

        <div style="margin-bottom:15px;">
            <label class="settings-label">üì¢ Teks Promo</label>
            <input type="text" id="set_promo" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; box-sizing:border-box;">
        </div>

        <div class="shipping-rules-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label class="settings-label" style="margin:0;">üöö Aturan Ongkir</label>
                <button onclick="addRule()" style="background:var(--primary); color:white; border:none; padding:4px 10px; border-radius:6px; font-size:11px; cursor:pointer;">+ Tambah</button>
            </div>
            <div id="rules-container" style="max-height: 120px; overflow-y: auto; font-size:12px;"></div>
        </div>

        <div style="margin-bottom:15px;">
            <label class="settings-label">üì¶ Diskon Barang</label>
            <div class="input-group-merged">
               <input type="number" id="set_barang" placeholder="0" min="0">
               <select id="type_barang"><option value="nominal">Rp</option><option value="persen">%</option></select>
           </div>
       </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
                <label class="settings-label">üéüÔ∏è Kode Voucher</label>
                <input type="text" id="set_v_code" style="width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; font-weight:700; text-transform:uppercase;">
            </div>
            <div>
                <label class="settings-label">üí∞ Potongan</label>
                <div class="input-group-merged">
                    <input type="number" id="set_v_val" min="0">
                    <select id="type_voucher"><option value="nominal">Rp</option><option value="persen">%</option></select>
                </div>
            </div>
        </div>

        <div style="background:#f9fafb; padding:12px; border-radius:10px; margin-bottom:20px;">
            <label class="settings-label">üìä Batas Kuota</label>
            <div class="input-group-merged">
                <input type="number" id="set_v_limit" min="0">
                <div style="font-size:11px; color:#6b7280; display:flex; align-items:center; padding-right:10px; white-space:nowrap; border-left:1px solid #f3f4f6; margin-left:5px;">
                    Pakai: <b id="view_used" style="color:var(--primary); margin-left:4px;">0</b>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="flex:1; padding:12px; background:#f3f4f6; color:#6b7280; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Batal</button>
            <button onclick="saveSettings()" style="flex:2; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Simpan Perubahan</button>
        </div>
    </div>
</div>

<div id="successToast" class="success-toast">
    <div style="background:#10b981; color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center;"><i data-lucide="check" size="14"></i></div>
    <div class="toast-text" style="font-size:13px; font-weight:700;">Data Disimpan!</div>
</div>

<script>
    // 1. CONFIG
    const config = {
        url: "https://iltvpnplysjeaxufiokg.supabase.co",
        anon: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU"
    };
    const db = window.supabase.createClient(config.url, config.anon);
    let allOrders = [], charts = {}, currentRules = [];

    // 2. AUTH
    async function checkAuth() {
        const { data: { session } } = await db.auth.getSession();
        if (!session) window.location.href = 'login.html';
    }
    checkAuth();
    async function logout() { await db.auth.signOut(); window.location.href = 'login.html'; }

    // 3. DATA FETCHING
    async function fetchData() {
        const container = document.getElementById('orders-container');
        container.innerHTML = '<div id="loading">Memperbarui data...</div>';
        try {
            const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            allOrders = data;
            calculateStats();
            renderCharts();
            setGrouping('route');
            lucide.createIcons();
        } catch (e) { alert("Error: " + e.message); }
    }

    // 4. CHART ENGINE (SOLUSI DATA TIDAK MUNCUL)
    function createChart(id, type, data) {
        const canvas = document.getElementById(id);
        if (!canvas) return;

        // Check if library exists
        if (typeof Chart === 'undefined') {
            canvas.parentNode.innerHTML = '<div style="font-size:10px; color:red; text-align:center;">Library Error</div>';
            return;
        }

        if (charts[id]) charts[id].destroy(); // Mencegah tumpang tindih data

        const ctx = canvas.getContext('2d');
        charts[id] = new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
            }
        });
    }

    function renderCharts() {
        // Customer loyalitas
        const counts = {};
        allOrders.forEach(o => counts[o.nama] = (counts[o.nama] || 0) + 1);
        const top = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
        createChart('chartCustomer', 'bar', {
            labels: top.map(i => i[0]),
            datasets: [{ label: 'Order', data: top.map(i => i[1]), backgroundColor: '#0f7a63' }]
        });

        // Radius
        const rad = { 'Radius Dekat': 0, 'Radius Jauh': 0 };
        allOrders.forEach(o => parseFloat(o.jarak_km) <= 2.5 ? rad['Radius Dekat']++ : rad['Radius Jauh']++);
        createChart('chartArea', 'doughnut', {
            labels: Object.keys(rad),
            datasets: [{ data: Object.values(rad), backgroundColor: ['#10b981', '#ef4444'] }]
        });

        // Payment
        const pay = {};
        allOrders.forEach(o => pay[o.metode_bayar] = (pay[o.metode_bayar] || 0) + 1);
        createChart('chartPayment', 'pie', {
            labels: Object.keys(pay),
            datasets: [{ data: Object.values(pay), backgroundColor: ['#3b82f6', '#10b981'] }]
        });

        // Promo
        const vch = allOrders.filter(o => o.nilai_voucher > 0).length;
        createChart('chartDiscount', 'bar', {
            labels: ['Voucher', 'Normal'],
            datasets: [{ data: [vch, allOrders.length - vch], backgroundColor: ['#8b5cf6', '#9ca3af'] }]
        });
    }

    // 5. SETTINGS ENGINE
    async function openSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        const { data } = await db.from('store_settings').select('*').limit(1).single();
        if (data) {
            document.getElementById('set_promo').value = data.teks_promo;
            document.getElementById('set_barang').value = data.diskon_barang;
            document.getElementById('type_barang').value = data.tipe_barang;
            document.getElementById('set_v_code').value = data.voucher_kode;
            document.getElementById('set_v_val').value = data.voucher_nilai;
            document.getElementById('type_voucher').value = data.tipe_voucher;
            document.getElementById('set_v_limit').value = data.voucher_limit;
            document.getElementById('view_used').innerText = data.voucher_used;
            currentRules = data.shipping_rules || [];
            renderRules();
        }
    }

    async function saveSettings() {
        const btn = event.target;
        btn.innerText = "‚è≥ Menyimpan...";
        btn.disabled = true;

        const updateData = {
            teks_promo: document.getElementById('set_promo').value,
            diskon_barang: parseInt(document.getElementById('set_barang').value) || 0,
            tipe_barang: document.getElementById('type_barang').value,
            voucher_kode: document.getElementById('set_v_code').value.toUpperCase(),
            voucher_nilai: parseInt(document.getElementById('set_v_val').value) || 0,
            tipe_voucher: document.getElementById('type_voucher').value,
            voucher_limit: parseInt(document.getElementById('set_v_limit').value) || 0,
            shipping_rules: currentRules
        };

        try {
            // Deteksi ID dinamis
            const { data: check } = await db.from('store_settings').select('id').limit(1).single();
            const { error } = await db.from('store_settings').update(updateData).eq('id', check.id);
            
            if (error) throw error;

            document.getElementById('settingsModal').style.display = 'none';
            const toast = document.getElementById('successToast');
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        } catch (e) { alert(e.message); }
        btn.innerText = "Simpan Perubahan"; btn.disabled = false;
    }

    // RULES HELPER
    function renderRules() {
        const c = document.getElementById('rules-container');
        c.innerHTML = currentRules.length ? "" : "Belum ada aturan.";
        currentRules.forEach((r, i) => {
            const d = document.createElement('div');
            d.style.cssText = "background:#fff; border:1px solid #eee; padding:8px; border-radius:6px; margin-bottom:5px; position:relative; font-size:11px;";
            d.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <span>Jarak: ${r.minDist}-${r.maxDist}km</span>
                    <span>Min: ${r.minQty}</span>
                </div>
                <div>Diskon: ${r.val}${r.type === 'persen' ? '%' : 'Rp'}</div>
                <button onclick="currentRules.splice(${i},1);renderRules();" style="position:absolute; top:4px; right:4px; border:none; color:red; background:none; cursor:pointer;">‚úï</button>
            `;
            c.appendChild(d);
        });
    }
    function addRule() {
        const d = { minDist: 0, maxDist: 5, minQty: 1, type: 'persen', val: 100 };
        currentRules.push(d); renderRules();
    }

    // OTHER UTILS
    function calculateStats() {
        const rev = allOrders.reduce((a, b) => a + (b.total_bayar || 0), 0);
        document.getElementById('stat-revenue').innerText = formatRupiah(rev);
        document.getElementById('stat-count').innerText = allOrders.length;
        const vch = (allOrders.filter(o => o.nilai_voucher > 0).length / allOrders.length * 100).toFixed(1);
        document.getElementById('stat-voucher').innerText = (isNaN(vch) ? 0 : vch) + '%';
    }
    const formatRupiah = (n) => 'Rp ' + n.toLocaleString('id-ID');
    function setGrouping(m) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`button[onclick="setGrouping('${m}')"]`);
        if(btn) btn.classList.add('active');
        const c = document.getElementById('orders-container');
        c.innerHTML = "";
        if (m === 'area') renderGroup("Radius < 2.5KM", allOrders.filter(o => parseFloat(o.jarak_km) <= 2.5), c);
        else renderGroup("Semua Pesanan", allOrders, c);
    }
    function renderGroup(t, o, c) {
        if(!o.length) return;
        let rows = o.map(i => `<tr><td><b>${i.nama}</b><br><small>${i.alamat}</small></td><td>${i.jarak_km}km</td><td>${i.jumlah_butir}</td><td>${formatRupiah(i.total_bayar)}</td><td><span class="status-badge ${i.metode_bayar==='QRIS'?'badge-qris':'badge-cash'}">${i.metode_bayar}</span></td></tr>`).join('');
        const g = document.createElement('div'); g.className = 'order-group';
        g.innerHTML = `<div class="group-header"><b>${t}</b> <span class="group-badge">${o.length}</span></div><div style="overflow-x:auto;"><table class="order-table"><thead><tr><th>User</th><th>Jarak</th><th>Qty</th><th>Total</th><th>Metode</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        c.appendChild(g);
    }

    document.addEventListener('DOMContentLoaded', fetchData);
</script>

</body>
</html>
