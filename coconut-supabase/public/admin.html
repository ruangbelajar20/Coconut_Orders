<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Penjual - Bumi Jelly D'Hasna</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        :root {
            --primary: #0f7a63;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text-main); }
        
        .dashboard-container {
            max-width: 1600px; width: 98%; margin: 20px auto; padding: 0 10px;
            display: grid; grid-template-columns: 1fr; gap: 20px; box-sizing: border-box;
        }
        
        @media (max-width: 768px) { .dashboard-container { width: 95%; } }

        /* HEADER SECTION */
        .header {
            background: var(--primary); color: white; padding: 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(15, 122, 99, 0.2);
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 800; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .refresh-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; gap: 8px; align-items: center; transition: 0.3s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.4); }

        /* CARDS & CHARTS */
        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-light); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        .stat-label { font-size: 13px; color: var(--text-light); }
        .charts-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* TABLE */
        .grouping-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #e5e7eb; padding: 8px 16px; border-radius: 50px; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .order-group { margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
        .group-header { background: #f9fafb; padding: 15px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .group-title { font-weight: 700; color: var(--primary); font-size: 14px; }
        .order-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .order-table th { text-align: left; padding: 12px 20px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #eee; }
        .order-table td { padding: 12px 20px; border-bottom: 1px solid #f3f4f6; color: #333; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-qris { background: #dbeafe; color: #1e40af; }
        .badge-cash { background: #d1fae5; color: #065f46; }
        #loading { text-align: center; padding: 50px; color: var(--text-light); }

        /* MODAL COMPACT STYLE */
        .modal-overlay { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); align-items:center; justify-content:center; 
            z-index:9999; backdrop-filter: blur(4px); 
        }
        .modal-box { 
            background:white; padding:25px; border-radius:16px; width:95%; max-width:500px; 
            box-shadow:0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; 
            animation: modalPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes modalPop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .settings-label { font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 4px; display: block; text-transform: uppercase; }
        .input-group-merged { display: flex; width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: #fff; box-sizing: border-box; }
        .input-group-merged input { flex: 1; min-width: 0; border: none !important; padding: 10px; font-size: 13px; outline: none; }
        .input-group-merged select { width: 60px; flex-shrink: 0; border: none !important; border-left: 1px solid #f3f4f6 !important; background: #f9fafb; font-weight: 700; color: var(--primary); text-align: center; font-size: 12px; cursor: pointer; outline: none; }
        .shipping-rules-box { border: 1px dashed #d1d5db; padding: 12px; border-radius: 10px; background: #fdfdfd; margin-bottom: 15px; }

        /* SUCCESS TOAST */
        .success-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: white; padding: 12px 25px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            display: flex; align-items: center; gap: 12px; z-index: 10000;
            border: 2px solid #10b981; opacity: 0; transition: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .success-toast.active { transform: translateX(-50%) translateY(0); opacity: 1; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        @media (max-width: 640px) {
            .header { flex-direction: column; text-align: center; gap: 15px; }
            .btn-group, .refresh-btn { width: 100%; justify-content: center; }
            .charts-wrapper { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <div>
            <h1>Dashboard Penjual</h1>
            <div style="font-size:13px; opacity:0.9;">Analisis & Pengelompokan Pesanan</div>
        </div>
        <div class="btn-group">
            <button class="refresh-btn" onclick="openSettings()"><i data-lucide="settings"></i> Atur Toko</button>
            <button class="refresh-btn" onclick="fetchData()"><i data-lucide="refresh-cw"></i> Refresh</button>
            <button class="refresh-btn" onclick="logout()" style="background:#ef4444;"><i data-lucide="log-out"></i> Keluar</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <div class="card-title"><i data-lucide="dollar-sign"></i> Total Pendapatan</div>
            <div class="stat-value" id="stat-revenue">Rp 0</div>
            <div class="stat-label">Semua pesanan masuk</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="shopping-bag"></i> Total Pesanan</div>
            <div class="stat-value" id="stat-count">0</div>
            <div class="stat-label">Transaksi berhasil</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="ticket"></i> Voucher Dipakai</div>
            <div class="stat-value" id="stat-voucher">0%</div>
            <div class="stat-label">Persentase penggunaan</div>
        </div>
    </div>

    <div class="charts-wrapper">
        <div class="card">
            <div class="card-title">üèÜ Top Pelanggan</div>
            <div class="chart-container"><canvas id="chartCustomer"></canvas></div>
        </div>
        <div class="card">
            <div class="card-title">üìç Sebaran Wilayah</div>
            <div class="chart-container"><canvas id="chartArea"></canvas></div>
        </div>
    </div>
    <div class="charts-wrapper">
         <div class="card">
            <div class="card-title">üí∞ Metode Pembayaran</div>
            <div class="chart-container"><canvas id="chartPayment"></canvas></div>
        </div>
        <div class="card">
             <div class="card-title">üìâ Efektivitas Promo</div>
            <div class="chart-container"><canvas id="chartDiscount"></canvas></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i data-lucide="truck"></i> Pengiriman</div>
        <div class="grouping-controls">
            <button class="filter-btn active" onclick="setGrouping('route')">Rute Satu Arah</button>
            <button class="filter-btn" onclick="setGrouping('latest')">Terbaru</button>
            <button class="filter-btn" onclick="setGrouping('area')">Radius Dekat</button>
        </div>
        <div id="orders-container">
            <div id="loading">Mengambil data dari Supabase...</div>
        </div>
    </div>
</div>

<div id="successToast" class="success-toast">
    <div style="background:#10b981; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;"><i data-lucide="check" size="16"></i></div>
    <div class="toast-text">Pengaturan Toko Berhasil Diupdate!</div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f3f4f6; padding-bottom:10px;">
            <h3 style="margin:0; color:var(--primary); font-size:16px; font-weight:800;">‚öôÔ∏è Pengaturan Toko</h3>
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="background:none; border:none; color:#999; cursor:pointer;"><i data-lucide="x" size="20"></i></button>
        </div>

        <div style="margin-bottom:15px;">
            <label class="settings-label">üì¢ Teks Promo Berjalan</label>
            <input type="text" id="set_promo" style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; box-sizing:border-box;">
        </div>

        <div class="shipping-rules-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label class="settings-label" style="margin:0; color:var(--primary);">üöö Aturan Diskon Ongkir</label>
                <button onclick="addRule()" style="background:var(--primary); color:white; border:none; padding:4px 10px; border-radius:6px; font-size:11px; cursor:pointer;">+ Tambah</button>
            </div>
            <div id="rules-container" style="max-height: 120px; overflow-y: auto; font-size:12px;"></div>
        </div>

        <div style="margin-bottom:15px;">
             <label class="settings-label">üì¶ Diskon Barang</label>
             <div class="input-group-merged">
                <input type="number" id="set_barang" placeholder="0" min="0">
                <select id="type_barang"><option value="nominal">Rp</option><option value="persen">%</option></select>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
            <div>
                <label class="settings-label">üéüÔ∏è Kode Voucher</label>
                <input type="text" id="set_v_code" style="width:100%; padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; font-weight:700; text-transform:uppercase;">
            </div>
            <div>
                <label class="settings-label">üí∞ Nilai Potongan</label>
                <div class="input-group-merged">
                    <input type="number" id="set_v_val" min="0">
                    <select id="type_voucher"><option value="nominal">Rp</option><option value="persen">%</option></select>
                </div>
            </div>
        </div>

        <div style="background:#f9fafb; padding:12px; border-radius:10px; margin-bottom:20px;">
            <label class="settings-label">üìä Batas Kuota Voucher</label>
            <div class="input-group-merged">
                <input type="number" id="set_v_limit" min="0">
                <div style="font-size:11px; color:#6b7280; display:flex; align-items:center; padding-right:10px; white-space:nowrap; border-left:1px solid #f3f4f6; margin-left:5px;">
                    Pakai: <b id="view_used" style="color:var(--primary); margin-left:4px;">0</b>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="flex:1; padding:12px; background:#f3f4f6; color:#6b7280; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Batal</button>
            <button onclick="saveSettings()" style="flex:2; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Simpan Perubahan</button>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIG ---
    const config = {
        url: "https://iltvpnplysjeaxufiokg.supabase.co",
        anon: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU"
    };
    const db = window.supabase.createClient(config.url, config.anon);
    let allOrders = [], charts = {}, currentRules = [];

    // --- 2. AUTH ---
    async function checkAuth() {
        const { data: { session } } = await db.auth.getSession();
        if (!session) window.location.href = 'login.html';
    }
    checkAuth();

    async function logout() { await db.auth.signOut(); window.location.href = 'login.html'; }

    // --- 3. DATA ENGINE ---
    async function fetchData() {
        const container = document.getElementById('orders-container');
        container.innerHTML = '<div id="loading">Sedang menyinkronkan data...</div>';
        try {
            const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            allOrders = data;
            calculateStats();
            renderCharts();
            setGrouping('route');
            lucide.createIcons();
        } catch (e) { alert("Error: " + e.message); }
    }

    function calculateStats() {
        const rev = allOrders.reduce((a, b) => a + (b.total_bayar || 0), 0);
        document.getElementById('stat-revenue').innerText = 'Rp ' + rev.toLocaleString('id-ID');
        document.getElementById('stat-count').innerText = allOrders.length;
        const vch = (allOrders.filter(o => o.nilai_voucher > 0).length / (allOrders.length || 1) * 100).toFixed(1);
        document.getElementById('stat-voucher').innerText = vch + '%';
    }

    // --- 4. CHART ENGINE (HANDAL & OPTIMAL) ---
    function createChart(id, type, data) {
        const canvas = document.getElementById(id);
        if (!canvas) return;

        // Safety Check: Pastikan library Chart.js sudah ada
        if (typeof Chart === 'undefined') {
            canvas.parentNode.innerHTML = '<div style="font-size:12px;color:red;text-align:center;padding:20px;">Library Gagal Dimuat</div>';
            return;
        }

        if (charts[id]) charts[id].destroy(); 

        const ctx = canvas.getContext('2d');
        charts[id] = new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { boxWidth: 10, font: { size: 11 }, padding: 15 } 
                    } 
                }
            }
        });
    }

    function renderCharts() {
        // Customer loyalitas
        const counts = {};
        allOrders.forEach(o => counts[o.nama] = (counts[o.nama] || 0) + 1);
        const top = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
        createChart('chartCustomer', 'bar', {
            labels: top.map(i => i[0]),
            datasets: [{ label: 'Total Order', data: top.map(i => i[1]), backgroundColor: '#0f7a63', borderRadius: 6 }]
        });

        // Radius
        const rad = { '< 2.5 KM': 0, '> 2.5 KM': 0 };
        allOrders.forEach(o => parseFloat(o.jarak_km) <= 2.5 ? rad['< 2.5 KM']++ : rad['> 2.5 KM']++);
        createChart('chartArea', 'doughnut', {
            labels: Object.keys(rad),
            datasets: [{ data: Object.values(rad), backgroundColor: ['#10b981', '#ef4444'] }]
        });

        // Payment
        const pay = {};
        allOrders.forEach(o => pay[o.metode_bayar] = (pay[o.metode_bayar] || 0) + 1);
        createChart('chartPayment', 'pie', {
            labels: Object.keys(pay),
            datasets: [{ data: Object.values(pay), backgroundColor: ['#3b82f6', '#10b981'] }]
        });

        // Voucher Efektivitas
        const vUsed = allOrders.filter(o => o.nilai_voucher > 0).length;
        createChart('chartDiscount', 'bar', {
            labels: ['Pakai Voucher', 'Tanpa Voucher'],
            datasets: [{ data: [vUsed, allOrders.length - vUsed], backgroundColor: ['#8b5cf6', '#9ca3af'], borderRadius: 6 }]
        });
    }

    // --- 5. SETTINGS ENGINE ---
    async function openSettings() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = 'flex';
        try {
            const { data } = await db.from('store_settings').select('*').limit(1).single();
            if (data) {
                document.getElementById('set_promo').value = data.teks_promo;
                document.getElementById('set_barang').value = data.diskon_barang;
                document.getElementById('type_barang').value = data.tipe_barang || 'nominal';
                document.getElementById('set_v_code').value = data.voucher_kode;
                document.getElementById('set_v_val').value = data.voucher_nilai;
                document.getElementById('type_voucher').value = data.tipe_voucher || 'nominal';
                document.getElementById('set_v_limit').value = data.voucher_limit;
                document.getElementById('view_used').innerText = data.voucher_used;
                currentRules = data.shipping_rules || [];
                renderRules();
            }
        } catch (e) { console.error("Load failed"); }
        lucide.createIcons();
    }

    async function saveSettings() {
        const btn = event.target;
        btn.innerText = "‚è≥ Menyimpan..."; btn.disabled = true;

        const updateData = {
            teks_promo: document.getElementById('set_promo').value,
            diskon_barang: parseInt(document.getElementById('set_barang').value) || 0,
            tipe_barang: document.getElementById('type_barang').value,
            voucher_kode: document.getElementById('set_v_code').value.toUpperCase(),
            voucher_nilai: parseInt(document.getElementById('set_v_val').value) || 0,
            tipe_voucher: document.getElementById('type_voucher').value,
            voucher_limit: parseInt(document.getElementById('set_v_limit').value) || 0,
            shipping_rules: currentRules
        };

        try {
            const { data: check } = await db.from('store_settings').select('id').limit(1).single();
            const { error } = await db.from('store_settings').update(updateData).eq('id', check.id);
            if (error) throw error;

            document.getElementById('settingsModal').style.display = 'none';
            const toast = document.getElementById('successToast');
            toast.classList.add('active');
            lucide.createIcons();
            setTimeout(() => toast.classList.remove('active'), 3000);
        } catch (e) { alert(e.message); }
        btn.innerText = "Simpan Perubahan"; btn.disabled = false;
    }

    function renderRules() {
        const c = document.getElementById('rules-container');
        c.innerHTML = currentRules.length ? "" : "<p style='color:#999;text-align:center;'>Belum ada aturan khusus.</p>";
        currentRules.forEach((r, i) => {
            const d = document.createElement('div');
            d.style.cssText = "background:#fff; border:1px solid #eee; padding:8px; border-radius:8px; margin-bottom:5px; position:relative;";
            d.innerHTML = `
                <div style="font-size:11px; font-weight:600;">Jarak: ${r.minDist}-${r.maxDist}km | Min: ${r.minQty}</div>
                <div style="font-size:11px; color:var(--primary);">Diskon: ${r.val}${r.type === 'persen' ? '%' : 'Rp'}</div>
                <button onclick="currentRules.splice(${i},1);renderRules();" style="position:absolute; top:8px; right:8px; border:none; color:red; background:none; cursor:pointer;">‚úï</button>
            `;
            c.appendChild(d);
        });
    }

    function addRule() {
        currentRules.push({ minDist: 0, maxDist: 5, minQty: 1, type: 'persen', val: 100 });
        renderRules();
    }

    function setGrouping(m) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`button[onclick="setGrouping('${m}')"]`);
        if(btn) btn.classList.add('active');
        const c = document.getElementById('orders-container');
        c.innerHTML = "";
        
        const sorted = m === 'route' ? [...allOrders].sort((a,b) => parseFloat(a.jarak_km)-parseFloat(b.jarak_km)) : allOrders;
        const filtered = m === 'area' ? allOrders.filter(o => parseFloat(o.jarak_km) <= 2.5) : sorted;
        
        renderGroup(m === 'area' ? "Radius Prioritas" : "Daftar Pesanan", filtered, c);
    }

    function renderGroup(t, o, c) {
        if(!o.length) { c.innerHTML = "<div id='loading'>Tidak ada data.</div>"; return; }
        let rows = o.map(i => `<tr><td><strong>${i.nama}</strong><br><small>${i.alamat}</small></td><td>${i.jarak_km}km</td><td>${i.jumlah_butir}</td><td>Rp ${i.total_bayar.toLocaleString()}</td><td><span class="status-badge ${i.metode_bayar==='QRIS'?'badge-qris':'badge-cash'}">${i.metode_bayar}</span></td></tr>`).join('');
        const g = document.createElement('div'); g.className = 'order-group';
        g.innerHTML = `<div class="group-header"><strong>${t}</strong> <span class="group-badge">${o.length} Order</span></div><div style="overflow-x:auto;"><table class="order-table"><thead><tr><th>User</th><th>Jarak</th><th>Qty</th><th>Total</th><th>Metode</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        c.appendChild(g);
    }

    document.addEventListener('DOMContentLoaded', fetchData);
</script>

</body>
</html>
