<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Penjual - Bumi Jelly D'Hasna</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        :root {
            --primary: #0f7a63;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text-main); }
        
        /* LAYOUT GRID */
        .dashboard-container {
            max-width: 1600px; width: 98%; margin: 20px auto; padding: 0 10px;
            display: grid; grid-template-columns: 1fr; gap: 20px; box-sizing: border-box;
        }
        
        @media (max-width: 768px) { .dashboard-container { width: 95%; } }

        /* HEADER */
        .header {
            background: var(--primary); color: white; padding: 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(15, 122, 99, 0.2);
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 800; }
        .refresh-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; gap: 8px; align-items: center; transition: 0.3s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.4); }

        /* CARDS & CHARTS */
        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-light); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        .stat-label { font-size: 13px; color: var(--text-light); }
        .charts-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* TABLE */
        .grouping-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #e5e7eb; padding: 8px 16px; border-radius: 50px; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .order-group { margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
        .group-header { background: #f9fafb; padding: 15px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .group-title { font-weight: 700; color: var(--primary); font-size: 14px; }
        .group-badge { background: #d1fae5; color: #065f46; font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        .order-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .order-table th { text-align: left; padding: 12px 20px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #eee; }
        .order-table td { padding: 12px 20px; border-bottom: 1px solid #f3f4f6; color: #333; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-qris { background: #dbeafe; color: #1e40af; }
        .badge-cash { background: #d1fae5; color: #065f46; }
        #loading { text-align: center; padding: 50px; color: var(--text-light); }

        /* RESPONSIVE HEADER */
        @media (max-width: 640px) {
            .header { flex-direction: column; text-align: center; gap: 15px; }
            .header > div, .header button, .header > div:last-child { width: 100%; justify-content: center; }
            .header > div:last-child { display: flex; flex-direction: column; gap: 10px; }
            .charts-wrapper { grid-template-columns: 1fr; }
        }
        /* --- MODAL STYLE COMPACT & MODERN --- */
        .modal-overlay { 
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); align-items:center; justify-content:center; 
            z-index:9999; backdrop-filter: blur(4px); /* Efek blur di belakang */
        }
        
        .modal-box { 
            background:white; padding:25px; border-radius:16px; 
            width:95%; max-width:500px; /* Lebar dibatasi agar compact */
            box-shadow:0 20px 60px rgba(0,0,0,0.3); position:relative; 
            max-height: 90vh; overflow-y: auto; 
            animation: modalPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        @keyframes modalPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Grid 2 Kolom Rapat */
        .settings-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 12px; 
        }
        
        .settings-label { 
            font-size: 12px; font-weight: 700; color: var(--text-main); 
            margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* Input Group Modern */
        .input-group-merged { 
            display: flex; width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; 
            overflow: hidden; background: #fff; transition: 0.2s;
        }
        .input-group-merged:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(15,122,99,0.1); }

        .input-group-merged input { 
            flex: 1; min-width: 0; border: none !important; padding: 8px 12px; 
            font-size: 13px; outline: none; font-weight: 600; color: #333;
        }
        
        .input-group-merged select { 
            width: 50px; border: none !important; border-left: 1px solid #f3f4f6 !important; 
            background: #f9fafb; font-weight: 700; color: var(--primary); 
            text-align: center; font-size: 12px; cursor: pointer; outline: none; 
        }

        /* Box Aturan Ongkir Compact */
        .shipping-rules-box { 
            border: 1px dashed #d1d5db; padding: 12px; border-radius: 10px; 
            background: #fdfdfd; margin-bottom: 15px; 
        }
        
        /* --- NOTIFIKASI SUKSES MODERN (PULSE) --- */
        .success-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: white; padding: 12px 25px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            display: flex; align-items: center; gap: 12px; z-index: 10000;
            border: 2px solid #10b981; opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        .success-toast.active {
            transform: translateX(-50%) translateY(0); opacity: 1;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .toast-icon { 
            width: 24px; height: 24px; background: #10b981; color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; 
        }
        .toast-text { font-size: 13px; font-weight: 700; color: #064e3b; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="header">
        <div>
            <h1>Dashboard Penjual</h1>
            <div style="font-size:13px; opacity:0.9;">Analisis & Pengelompokan Pesanan</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="refresh-btn" onclick="openSettings()"><i data-lucide="settings"></i> Atur Toko</button>
            <button class="refresh-btn" onclick="fetchData()"><i data-lucide="refresh-cw"></i> Refresh</button>
            <button class="refresh-btn" onclick="logout()" style="background:#ef4444;"><i data-lucide="log-out"></i> Keluar</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <div class="card-title"><i data-lucide="dollar-sign"></i> Total Pendapatan</div>
            <div class="stat-value" id="stat-revenue">Rp 0</div>
            <div class="stat-label">Semua pesanan masuk</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="shopping-bag"></i> Total Pesanan</div>
            <div class="stat-value" id="stat-count">0</div>
            <div class="stat-label">Transaksi berhasil</div>
        </div>
        <div class="card">
            <div class="card-title"><i data-lucide="ticket"></i> Voucher Dipakai</div>
            <div class="stat-value" id="stat-voucher">0%</div>
            <div class="stat-label">Persentase penggunaan</div>
        </div>
    </div>

    <div class="charts-wrapper">
        <div class="card">
            <div class="card-title">üèÜ Top Pelanggan (Loyalitas)</div>
            <div class="chart-container"><canvas id="chartCustomer"></canvas></div>
        </div>
        <div class="card">
            <div class="card-title">üìç Sebaran Wilayah (Radius)</div>
            <div class="chart-container"><canvas id="chartArea"></canvas></div>
        </div>
    </div>
    <div class="charts-wrapper">
         <div class="card">
            <div class="card-title">üí∞ Tren Metode Pembayaran</div>
            <div class="chart-container"><canvas id="chartPayment"></canvas></div>
        </div>
        <div class="card">
             <div class="card-title">üìâ Efektivitas Diskon & Voucher</div>
            <div class="chart-container"><canvas id="chartDiscount"></canvas></div>
        </div>
    </div>

    <div class="card">
        <div class="card-title"><i data-lucide="truck"></i> Pengelompokan Pengiriman (Smart Routing)</div>
        <div class="grouping-controls">
            <button class="filter-btn active" onclick="setGrouping('route')">Rute Satu Arah (Cluster Jarak)</button>
            <button class="filter-btn" onclick="setGrouping('latest')">Pesanan Terbaru</button>
            <button class="filter-btn" onclick="setGrouping('area')">Radius Dekat (< 2.5KM)</button>
        </div>
        <div id="orders-container">
            <div id="loading">Mengambil data dari Supabase...</div>
        </div>
    </div>
</div>

<div id="successToast" class="success-toast">
    <div class="toast-icon"><i data-lucide="check"></i></div>
    <div class="toast-text">Pengaturan Berhasil Disimpan!</div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f3f4f6; padding-bottom:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <h3 style="margin:0; color:var(--text-main); font-size:16px; font-weight:800;">‚öôÔ∏è Pengaturan Toko</h3>
            </div>
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="background:none; border:none; color:#999; cursor:pointer; transition:0.2s;"><i data-lucide="x" size="20"></i></button>
        </div>

        <div style="margin-bottom:15px;">
            <label class="settings-label">üì¢ Teks Promo Berjalan</label>
            <input type="text" id="set_promo" placeholder="Contoh: Diskon Hari Ini!" style="width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; box-sizing:border-box; outline:none;">
        </div>

        <div class="shipping-rules-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label class="settings-label" style="margin:0; color:var(--primary);">üöö Aturan Diskon Ongkir</label>
                <button onclick="addRule()" style="background:var(--primary); color:white; border:none; padding:4px 10px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer;">+ Tambah</button>
            </div>
            <div id="rules-container" style="max-height: 120px; overflow-y: auto; padding-right:5px; font-size:12px;"></div>
            <small style="color:#9ca3af; font-size:10px; display:block; margin-top:5px;">*Sistem membaca aturan dari atas ke bawah.</small>
        </div>

        <div style="margin-bottom:15px;">
             <label class="settings-label">üì¶ Diskon Barang</label>
             <div class="input-group-merged">
                <input type="number" id="set_barang" placeholder="0" min="0">
                <select id="type_barang">
                    <option value="nominal">Rp</option>
                    <option value="persen">%</option>
                </select>
            </div>
        </div>

        <hr style="border:none; border-top:1px dashed #e5e7eb; margin:15px 0;">

        <div class="settings-grid">
            <div>
                <label class="settings-label">üéüÔ∏è Kode Voucher</label>
                <input type="text" id="set_v_code" placeholder="KODE" style="width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; font-weight:700; text-transform:uppercase; box-sizing:border-box; outline:none;">
            </div>
            <div>
                <label class="settings-label">üí∞ Nilai Potongan</label>
                <div class="input-group-merged">
                    <input type="number" id="set_v_val" placeholder="0" min="0">
                    <select id="type_voucher">
                        <option value="nominal">Rp</option>
                        <option value="persen">%</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-grid">
             <div style="grid-column: span 2;">
                <label class="settings-label">üìä Batas Kuota (Orang)</label>
                <div class="input-group-merged">
                    <input type="number" id="set_v_limit" placeholder="0 (Tanpa Batas)" min="0">
                    <div style="font-size:11px; color:#6b7280; display:flex; align-items:center; padding-right:10px; background:#f9fafb; white-space:nowrap; border-left:1px solid #f3f4f6;">
                        Terpakai: <b id="view_used" style="color:var(--primary); margin-left:4px;">0</b>
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="flex:1; padding:10px; background:#f3f4f6; color:#6b7280; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;">Batal</button>
            <button onclick="saveSettings()" style="flex:2; padding:10px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; box-shadow:0 4px 10px rgba(15,122,99,0.2);">Simpan Perubahan</button>
        </div>
    </div>
</div>

<script>
    let currentRules = [];
    
    // 1. KONFIGURASI SUPABASE
    const config = {
        url: "https://iltvpnplysjeaxufiokg.supabase.co",
        anon: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU"
    };
    const db = window.supabase.createClient(config.url, config.anon);
    
    lucide.createIcons();
    let allOrders = [];
    let charts = {};

    // --- CEK SESI LOGIN ---
    async function checkAuth() {
        const { data: { session } } = await db.auth.getSession();
        if (!session) window.location.href = 'login.html'; 
    }
    checkAuth();

    async function logout() {
        const { error } = await db.auth.signOut();
        if (!error) window.location.href = 'login.html';
    }

    // --- FETCH DATA UTAMA ---
    async function fetchData() {
        document.getElementById('orders-container').innerHTML = '<div id="loading">Sedang memuat data terbaru...</div>';
        try {
            const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            allOrders = data;
            calculateStats();
            renderCharts();
            setGrouping('route'); 
        } catch (err) {
            console.error(err);
            alert("Gagal mengambil data: " + err.message);
        }
    }

    const formatRupiah = (num) => 'Rp ' + num.toLocaleString('id-ID');

    function calculateStats() {
        const totalRev = allOrders.reduce((sum, o) => sum + (o.total_bayar || 0), 0);
        const totalOrder = allOrders.length;
        const voucherCount = allOrders.filter(o => o.nilai_voucher > 0).length;
        const voucherPercent = totalOrder > 0 ? ((voucherCount / totalOrder) * 100).toFixed(1) : 0;

        document.getElementById('stat-revenue').innerText = formatRupiah(totalRev);
        document.getElementById('stat-count').innerText = totalOrder;
        document.getElementById('stat-voucher').innerText = voucherPercent + '%';
    }

    // --- CHART FUNCTIONS ---
    function renderCharts() {
        const customerCounts = {};
        allOrders.forEach(o => { customerCounts[o.nama] = (customerCounts[o.nama] || 0) + 1; });
        const sortedCust = Object.entries(customerCounts).sort((a,b) => b[1] - a[1]).slice(0, 5); 

        createChart('chartCustomer', 'bar', {
            labels: sortedCust.map(i => i[0]),
            datasets: [{ label: 'Jumlah Pembelian', data: sortedCust.map(i => i[1]), backgroundColor: '#0f7a63', borderRadius: 5 }]
        });

        const radiusGroups = { '< 2.5 KM': 0, '2.5 - 5 KM': 0, '> 5 KM': 0 };
        allOrders.forEach(o => {
            const dist = parseFloat(o.jarak_km);
            if(dist <= 2.5) radiusGroups['< 2.5 KM']++;
            else if(dist <= 5) radiusGroups['2.5 - 5 KM']++;
            else radiusGroups['> 5 KM']++;
        });

        createChart('chartArea', 'doughnut', {
            labels: Object.keys(radiusGroups),
            datasets: [{ data: Object.values(radiusGroups), backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }]
        });

        const payMethods = {};
        allOrders.forEach(o => { payMethods[o.metode_bayar] = (payMethods[o.metode_bayar] || 0) + 1; });
        
        createChart('chartPayment', 'pie', {
            labels: Object.keys(payMethods),
            datasets: [{ data: Object.values(payMethods), backgroundColor: ['#3b82f6', '#10b981'] }]
        });

        const voucherUsed = allOrders.filter(o => o.nilai_voucher > 0).length;
        const noVoucher = allOrders.length - voucherUsed;
        
        createChart('chartDiscount', 'bar', {
            labels: ['Pakai Voucher', 'Tanpa Voucher'],
            datasets: [{ label: 'Jumlah Transaksi', data: [voucherUsed, noVoucher], backgroundColor: ['#8b5cf6', '#9ca3af'], borderRadius: 5 }]
        });
    }

    function createChart(id, type, data) {
        // 1. PENGAMAN (SAFETY CHECK)
        // Cek apakah elemen kanvas ada DAN apakah library Chart sudah dimuat
        const canvas = document.getElementById(id);
        
        if (!canvas) {
            console.warn(`Elemen grafik dengan ID '${id}' tidak ditemukan.`);
            return;
        }

        if (typeof Chart === 'undefined') {
            console.error("Library Chart.js gagal dimuat (Cek koneksi internet). Grafik dilewati.");
            // Tampilkan pesan error di tempat grafik agar user tahu
            canvas.parentNode.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:red;font-size:12px;">Gagal memuat grafik (Koneksi Error)</div>';
            return;
        }

        // 2. BERSIHKAN CHART LAMA (MEMORY OPTIMIZATION)
        // Mencegah memory leak atau grafik menumpuk saat refresh
        if (charts[id]) {
            charts[id].destroy();
        }

        // 3. RENDER CHART
        const ctx = canvas.getContext('2d');
        charts[id] = new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 11 },
                            boxWidth: 12
                        }
                    }
                },
                animation: {
                    duration: 800 // Optimalisasi animasi agar tidak berat di HP
                }
            }
        });
    }

    // --- PENGELOMPOKAN (GROUPING) ---
    function setGrouping(mode) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        let targetBtn = null;
        try { if (typeof event !== 'undefined' && event && event.type === 'click') targetBtn = event.target; } catch (e) {}
        if (!targetBtn) targetBtn = document.querySelector(`button[onclick="setGrouping('${mode}')"]`);
        if (targetBtn) targetBtn.classList.add('active');

        const container = document.getElementById('orders-container');
        container.innerHTML = "";
        
        // Logika sederhana Clustering Jarak (sebagai contoh)
        if (mode === 'route') {
            const sorted = [...allOrders].sort((a,b) => parseFloat(a.jarak_km) - parseFloat(b.jarak_km));
            renderGroup("Urutan Jarak (Terdekat - Terjauh)", sorted, container);
        } else if (mode === 'latest') {
            renderGroup("Semua Pesanan (Terbaru)", allOrders, container);
        } else if (mode === 'area') {
            const closeOrders = allOrders.filter(o => parseFloat(o.jarak_km) <= 2.5);
            renderGroup("Radius Prioritas (< 2.5 KM)", closeOrders, container);
        }
    }

    function renderGroup(title, orders, container) {
        if (orders.length === 0) return;
        const groupDiv = document.createElement('div');
        groupDiv.className = 'order-group';
        let rows = '';
        orders.forEach(o => {
            const date = new Date(o.created_at).toLocaleDateString('id-ID', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
            rows += `<tr><td><strong>${o.nama}</strong><br><small style="color:#666">${o.alamat}</small></td><td>${o.jarak_km} KM</td><td>${o.jumlah_butir} Btr</td><td>${formatRupiah(o.total_bayar)}</td><td><span class="status-badge ${o.metode_bayar === 'QRIS' ? 'badge-qris' : 'badge-cash'}">${o.metode_bayar}</span></td><td style="font-size:11px; color:#888;">${date}</td></tr>`;
        });
        groupDiv.innerHTML = `<div class="group-header"><div class="group-title">${title}</div><div class="group-badge">${orders.length} Pesanan</div></div><div style="overflow-x:auto;"><table class="order-table"><thead><tr><th>Pelanggan</th><th>Jarak</th><th>Qty</th><th>Total</th><th>Metode</th><th>Waktu</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        container.appendChild(groupDiv);
    }

    document.addEventListener('DOMContentLoaded', fetchData);

    // --- LOGIKA SETTINGS & RULES (SISTEM PENGATURAN) ---
    function renderRules() {
        const container = document.getElementById('rules-container');
        container.innerHTML = "";
        if (currentRules.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:10px; color:#999; font-size:12px;">Belum ada aturan diskon ongkir.</div>';
            return;
        }
        currentRules.forEach((rule, index) => {
            const div = document.createElement('div');
            div.style.cssText = "background:white; border:1px solid #ddd; padding:10px; border-radius:8px; margin-bottom:8px; position:relative;";
            div.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">
                    <div><label style="font-size:10px; font-weight:bold;">Jarak (KM):</label><div style="display:flex; align-items:center; gap:5px;"><input type="number" value="${rule.minDist}" onchange="updateRule(${index}, 'minDist', this.value)" style="width:100%; padding:5px; border:1px solid #eee; border-radius:4px; font-size:11px;"><span>-</span><input type="number" value="${rule.maxDist}" onchange="updateRule(${index}, 'maxDist', this.value)" style="width:100%; padding:5px; border:1px solid #eee; border-radius:4px; font-size:11px;"></div></div>
                    <div><label style="font-size:10px; font-weight:bold;">Min. Qty:</label><input type="number" value="${rule.minQty}" onchange="updateRule(${index}, 'minQty', this.value)" style="width:100%; padding:5px; border:1px solid #eee; border-radius:4px; font-size:11px;"></div>
                </div>
                <div><label style="font-size:10px; font-weight:bold;">Diskon:</label><div style="display:flex; border:1px solid #eee; border-radius:4px; overflow:hidden;"><input type="number" value="${rule.val}" onchange="updateRule(${index}, 'val', this.value)" style="border:none; padding:5px; width:100%; font-size:11px;"><select onchange="updateRule(${index}, 'type', this.value)" style="border:none; background:#eee; font-size:11px;"><option value="nominal" ${rule.type === 'nominal' ? 'selected' : ''}>Rp</option><option value="persen" ${rule.type === 'persen' ? 'selected' : ''}>%</option></select></div></div>
                <button onclick="removeRule(${index})" style="position:absolute; top:5px; right:5px; background:#fee2e2; color:red; border:none; width:20px; height:20px; border-radius:50%; font-size:10px; cursor:pointer;">‚úï</button>
            `;
            container.appendChild(div);
        });
    }

    function addRule() { currentRules.push({ minDist: 0, maxDist: 5, minQty: 1, type: 'nominal', val: 0 }); renderRules(); }
    function removeRule(index) { currentRules.splice(index, 1); renderRules(); }
    function updateRule(index, field, value) {
        if(field === 'type') currentRules[index][field] = value;
        else currentRules[index][field] = parseFloat(value) || 0;
    }

    async function openSettings() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = 'flex';
        const { data } = await db.from('store_settings').select('*').eq('id', 1).single();
        if (data) {
            document.getElementById('set_promo').value = data.teks_promo;
            document.getElementById('set_barang').value = data.diskon_barang;
            document.getElementById('type_barang').value = data.tipe_barang || 'nominal';
            document.getElementById('set_v_code').value = data.voucher_kode;
            document.getElementById('set_v_val').value = data.voucher_nilai;
            document.getElementById('type_voucher').value = data.tipe_voucher || 'nominal';
            document.getElementById('set_v_limit').value = data.voucher_limit;
            document.getElementById('view_used').innerText = data.voucher_used;
            currentRules = data.shipping_rules || [];
            renderRules(); 
        }
    }

    // --- GANTI FUNGSI saveSettings LAMA DENGAN INI ---
    async function saveSettings() {
        const btnSimpan = event.target; // Tombol yang diklik
        btnSimpan.innerText = "üïµÔ∏è Sedang Mendiagnosa...";
        btnSimpan.disabled = true;

        // 1. AMBIL DATA DARI INPUT
        const promo = document.getElementById('set_promo').value;
        const barang = parseInt(document.getElementById('set_barang').value) || 0;
        const tBarang = document.getElementById('type_barang').value;
        const vCode = document.getElementById('set_v_code').value.toUpperCase();
        const vVal = parseInt(document.getElementById('set_v_val').value) || 0;
        const tVoucher = document.getElementById('type_voucher').value;
        const vLimit = parseInt(document.getElementById('set_v_limit').value) || 0;

        // 2. CEK LOGIKA VOUCHER USED
        const { data: oldData } = await db.from('store_settings').select('voucher_kode').limit(1).single();
        let newUsedCount = undefined;
        if (oldData && oldData.voucher_kode !== vCode) newUsedCount = 0;

        // 3. SIAPKAN DATA UPDATE
        // Perhatikan: shipping_rules mengambil dari variabel global currentRules
        const updateData = {
            teks_promo: promo,
            diskon_barang: barang,
            tipe_barang: tBarang,
            voucher_kode: vCode,
            voucher_nilai: vVal,
            tipe_voucher: tVoucher,
            voucher_limit: vLimit,
            shipping_rules: currentRules // <--- Pastikan ini tidak kosong
        };

        if (newUsedCount !== undefined) updateData.voucher_used = 0;

        // --- DIAGNOSA 1: CEK ARRAY RULES ---
        console.log("Data yang akan dikirim:", updateData.shipping_rules);
        if (currentRules.length === 0) {
            let konfirmasi = confirm("‚ö†Ô∏è PERHATIAN: Anda belum menambahkan 'Aturan Ongkir' (Daftar aturan kosong).\n\nApakah Anda yakin ingin menyimpan tanpa aturan ongkir?");
            if (!konfirmasi) {
                btnSimpan.innerText = "Simpan Perubahan";
                btnSimpan.disabled = false;
                return; // Batalkan simpan
            }
        }

        // --- DIAGNOSA 2: CARI ID ASLI DI DATABASE ---
        // Kita cari baris pertama yang ada di tabel, apapun ID-nya
        const { data: checkID, error: errID } = await db.from('store_settings').select('id').limit(1).single();
        
        if (errID || !checkID) {
            alert("‚ùå ERROR DATABASE: Tabel 'store_settings' kosong atau tidak bisa dibaca.\nPastikan Anda sudah Insert 1 baris data di Supabase.");
            btnSimpan.innerText = "Simpan Perubahan";
            btnSimpan.disabled = false;
            return;
        }

        const REAL_ID = checkID.id; // Ini ID yang benar (misal: 1, 2, atau 15)
        console.log("ID Asli di Database adalah:", REAL_ID);

        // 4. EKSEKUSI UPDATE DENGAN ID YANG BENAR
        const { data: hasilUpdate, error: errUpdate } = await db
            .from('store_settings')
            .update(updateData)
            .eq('id', REAL_ID) // Pakai ID asli, bukan hardcode 1
            .select(); // Minta balikan data untuk bukti

        // 5. LAPORAN HASIL
        if (errUpdate) {
            alert("‚ùå GAGAL: " + errUpdate.message);
        } else {
            // Tutup Modal Dulu
            document.getElementById('settingsModal').style.display = 'none';
            
            // Tampilkan Notifikasi Keren
            const toast = document.getElementById('successToast');
            toast.querySelector('.toast-text').innerText = "Pengaturan Toko Berhasil Diupdate!";
            toast.classList.add('active');
            
            // Refresh icon agar muncul
            lucide.createIcons();
    
            // Hilangkan notifikasi setelah 3 detik
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
        
        btnSimpan.innerText = "Simpan Perubahan";
        btnSimpan.disabled = false;
    }
</script>

</body>
</html>
