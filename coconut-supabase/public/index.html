<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Coconut Bumi Jelly D'Hasna</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-color: #2e7d32; /* Hijau Tua Segar */
            --accent-color: #81c784; /* Hijau Muda */
            --bg-color: #f7f9fc; /* Latar belakang sangat terang */
            --card-bg: #ffffff;
            --text-dark: #333333;
            --text-muted: #777777;
            --shadow-soft: 0 10px 30px -10px rgba(46, 125, 50, 0.1);
            --radius-xl: 24px;
            --radius-md: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-dark);
        }

        .container {
            background: var(--card-bg);
            width: 100%;
            max-width: 480px;
            padding: 40px 30px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        /* --- Header & Animasi Jelly --- */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .jelly-mascot-container {
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }

        /* Ilustrasi Kelapa Jelly dengan CSS */
        .coconut-jelly {
            width: 70px;
            height: 60px;
            background: linear-gradient(to bottom, #ffffff 40%, #e0e0e0 100%);
            border-radius: 50% 50% 40% 40% / 60% 60% 35% 35%;
            border: 4px solid #6d4c41; /* Warna batok */
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            /* Animasi Mengapung */
            animation: floatJelly 3s ease-in-out infinite;
        }
        
        .coconut-jelly::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 10%;
            width: 80%;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
        }

        @keyframes floatJelly {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.02); } /* Sedikit naik dan mengembang */
        }

        h2 {
            color: var(--primary-color);
            font-weight: 700;
            margin: 0;
            font-size: 22px;
        }
        .subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-top: 5px;
        }

        /* --- Form Styling Minimalis --- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #eee;
            border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            background: #fafafa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(129, 199, 132, 0.1);
        }

        .note {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* --- Total & Tombol --- */
        .total-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 20px;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 600;
            margin-top: 30px;
            box-shadow: 0 10px 20px -10px rgba(46, 125, 50, 0.5);
        }

        #total-display {
            font-size: 24px;
            font-weight: 700;
        }

        #btn-submit {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background-color: var(--text-dark);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #btn-submit:hover {
            background-color: #000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #btn-submit:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Upload Area & Error --- */
        .hidden { display: none; }
        
        #area-upload {
            background: #fff0f0;
            padding: 15px;
            border-radius: var(--radius-md);
            border: 1px dashed #e57373;
        }
        input[type="file"] {
            background: white;
            padding: 10px;
        }

        /* --- POPUP SUKSES BERDENYUT --- */
        .success-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .success-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .success-card {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transform: scale(0.8);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efek pantul */
        }

        .success-overlay.active .success-card {
            transform: scale(1);
        }

        .pulse-icon {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            margin: 0 auto 20px;
            /* Animasi Berdenyut */
            animation: pulseEffect 2s infinite;
        }

        @keyframes pulseEffect {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(46, 125, 50, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(46, 125, 50, 0);
            }
        }

        .success-card h3 {
            margin: 0 0 10px;
            color: var(--primary-color);
        }
        .success-card p {
            color: var(--text-muted);
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="jelly-mascot-container">
            <div class="coconut-jelly"></div>
        </div>
        <h2>Coconut Bumi Jelly D'Hasna</h2>
        <div class="subtitle">Segar Alami, Nikmat Tiada Henti</div>
    </header>

    <form id="orderForm">
        <div class="form-group">
            <label for="nama">Nama Pemesan</label>
            <input type="text" id="nama" placeholder="Masukkan nama Anda" required>
        </div>

        <div class="form-group">
            <label for="alamat">Alamat Lengkap</label>
            <textarea id="alamat" rows="3" placeholder="Jalan, Nomor, Patokan..." required></textarea>
        </div>

        <div class="form-group">
            <label for="jarak">Jarak dari Toko (KM)</label>
            <input type="number" id="jarak" step="0.1" min="0" placeholder="Cek di Google Maps, contoh: 5.5" required>
            <div class="note">Gratis ongkir untuk 4 KM pertama.</div>
        </div>

        <div class="form-group">
            <label for="jumlah">Jumlah Pesanan (Butir)</label>
            <input type="number" id="jumlah" min="1" value="1" required>
            <div class="note">Harga per butir: Rp 15.000</div>
        </div>

        <div class="form-group">
            <label for="pembayaran">Metode Pembayaran</label>
            <select id="pembayaran">
                <option value="Cash">Cash (Tunai saat diantar)</option>
                <option value="QRIS">QRIS / Transfer Bank</option>
            </select>
        </div>

        <div id="area-upload" class="form-group hidden">
            <label style="color: #d32f2f;">Upload Bukti Transfer (Wajib):</label>
            <input type="file" id="bukti_file" accept="image/*">
        </div>

        <div class="total-box">
            <span>Total Bayar</span>
            <span id="total-display">Rp 15.000</span>
        </div>

        <button type="submit" id="btn-submit">KIRIM PESANAN SEKARANG</button>
    </form>
</div>

<div class="success-overlay" id="successPopup">
    <div class="success-card">
        <div class="pulse-icon">✓</div>
        <h3>Pesanan Berhasil!</h3>
        <p>Terima kasih telah memesan.<br>Mengalihkan ke WhatsApp...</p>
    </div>
</div>


<script>
    // =============================================
    // 1. KONFIGURASI SUPABASE (WAJIB DIGANTI!)
    // =============================================
    // Masukkan URL dan ANON KEY dari Dashboard Supabase Anda di sini
    const SUPABASE_URL = "https://iltvpnplysjeaxufiokg.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU";
    // =============================================


    // Inisialisasi Client Supabase
    // Menggunakan nama variabel 'db' agar aman dari bentrok
    let db; 
    try {
        db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Koneksi Database Siap.");
    } catch (err) {
        console.error("Gagal inisialisasi database:", err);
    }


    // --- 2. LOGIKA FRONTEND (Tampilan & Hitungan) ---
    const inputJarak = document.getElementById('jarak');
    const inputJumlah = document.getElementById('jumlah');
    const inputPembayaran = document.getElementById('pembayaran');
    const displayTotal = document.getElementById('total-display');
    const areaUpload = document.getElementById('area-upload');
    const successPopup = document.getElementById('successPopup');

    // Fungsi Hitung Total Harga Real-time
    function hitungTotal() {
        const jumlah = parseFloat(inputJumlah.value) || 0;
        const jarak = parseFloat(inputJarak.value) || 0;
        
        const HARGA_PER_BUTIR = 15000;
        const JARAK_DASAR = 4; 
        const ONGKIR_PER_KM = 1000;

        let total = jumlah * HARGA_PER_BUTIR;

        if (jarak > JARAK_DASAR) {
            // Pembulatan ke atas (Math.ceil) untuk kelebihan jarak
            let kelebihan = Math.ceil(jarak - JARAK_DASAR); 
            total += (kelebihan * ONGKIR_PER_KM);
        }

        displayTotal.innerText = "Rp " + total.toLocaleString('id-ID');
        // Tambahkan animasi kecil saat harga berubah
        displayTotal.style.transform = "scale(1.1)";
        setTimeout(() => displayTotal.style.transform = "scale(1)", 200);
    }

    // Fungsi Toggle Area Upload
    function cekMetode() {
        if (inputPembayaran.value === 'QRIS') {
            areaUpload.classList.remove('hidden');
            // Animasi fade in sederhana
            areaUpload.style.opacity = 0;
            setTimeout(() => areaUpload.style.opacity = 1, 50);
        } else {
            areaUpload.classList.add('hidden');
        }
    }

    // Event Listeners (Agar otomatis berubah saat diketik/dipilih)
    inputJarak.addEventListener('input', hitungTotal);
    inputJumlah.addEventListener('input', hitungTotal);
    inputPembayaran.addEventListener('change', cekMetode);


    // --- 3. PROSES SUBMIT PESANAN (Kirim ke Vercel) ---
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault(); // Mencegah refresh halaman
        
        const btn = document.getElementById('btn-submit');
        const originalText = btn.innerText;
        btn.innerText = "⏳ Sedang Memproses...";
        btn.disabled = true;
        btn.style.opacity = 0.7;

        try {
            // Ambil data dari form
            const nama = document.getElementById('nama').value;
            const alamat = document.getElementById('alamat').value;
            const jarak = document.getElementById('jarak').value;
            const jumlah = document.getElementById('jumlah').value;
            const metode = document.getElementById('pembayaran').value;
            const fileInput = document.getElementById('bukti_file');
            
            let buktiUrl = "";

            // A. Proses Upload Gambar (Jika QRIS)
            if (metode === 'QRIS') {
                if (fileInput.files.length === 0) {
                    throw new Error("Anda memilih QRIS, wajib upload bukti transfer.");
                }
                
                const file = fileInput.files[0];
                // Buat nama file unik agar tidak tertimpa
                const fileName = `bukti-${Date.now()}-${Math.random().toString(36).substring(7)}.jpg`;
                
                // Upload ke Supabase Storage (menggunakan variabel 'db')
                const { data, error: uploadError } = await db.storage
                    .from('bukti-transfer')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // Dapatkan URL publik gambar
                const { data: urlData } = db.storage
                    .from('bukti-transfer')
                    .getPublicUrl(fileName);
                
                buktiUrl = urlData.publicUrl;
            }

            // B. Kirim Data Lengkap ke Backend Vercel (api/submit.js)
            const response = await fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nama, alamat, jarak, jumlah, metode, buktiUrl
                })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || "Terjadi kesalahan saat menyimpan data.");
            }

            // --- SUKSES! TAMPILKAN POPUP BERDENYUT ---
            successPopup.classList.add('active');

            // Format Pesan WhatsApp
            const pesanWA = `Halo Admin Coconut Bumi Jelly,\nSaya baru saja memesan via website.\n\nNama: *${nama}*\nAlamat: ${alamat}\nJumlah: ${jumlah} butir\nTotal: *${displayTotal.innerText}*\nMetode: ${metode}\n\nLink Bukti Bayar: ${buktiUrl || '-'}`;
            const linkWA = `https://wa.me/62895336907868?text=${encodeURIComponent(pesanWA)}`;

            // Tunggu 2.5 detik agar user melihat animasi popup, lalu alihkan
            setTimeout(() => {
                window.open(linkWA, '_blank');
                window.location.reload(); // Refresh halaman untuk pesanan baru
            }, 2500);

        } catch (err) {
            // Jika Error
            console.error(err);
            alert("❌ Gagal: " + err.message);
            btn.innerText = originalText;
            btn.disabled = false;
            btn.style.opacity = 1;
        }
    });

    // Jalankan fungsi awal saat halaman dimuat
    hitungTotal();
    cekMetode();
</script>

</body>
</html>
