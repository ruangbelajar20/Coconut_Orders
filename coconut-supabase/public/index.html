<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order Coconut Bumi Jelly D'Hasna</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary-color: #2e7d32; --accent-color: #81c784; --bg-color: #f7f9fc; 
            --card-bg: #ffffff; --text-dark: #333333; --text-muted: #777777;
            --shadow-soft: 0 10px 30px -10px rgba(46, 125, 50, 0.1);
            --radius-xl: 24px; --radius-md: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-color);
            margin: 0; padding: 20px; display: flex; justify-content: center;
            align-items: center; min-height: 100vh; color: var(--text-dark);
            -webkit-user-select: none; user-select: none;
        }

        .container {
            background: var(--card-bg); width: 100%; max-width: 480px;
            padding: 40px 30px; border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft); position: relative; overflow: hidden;
        }

        header { text-align: center; margin-bottom: 30px; }
        .jelly-mascot-container { height: 80px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .coconut-jelly {
            width: 70px; height: 60px; background: linear-gradient(to bottom, #ffffff 40%, #e0e0e0 100%);
            border-radius: 50% 50% 40% 40% / 60% 60% 35% 35%; border: 4px solid #6d4c41;
            position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: floatJelly 3s ease-in-out infinite;
        }
        @keyframes floatJelly { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        h2 { color: var(--primary-color); font-weight: 700; margin: 0; font-size: 22px; }
        .subtitle { color: var(--text-muted); font-size: 14px; margin-top: 5px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px; }

        input, textarea, select {
            width: 100%; padding: 14px 16px; border: 2px solid #eee; border-radius: var(--radius-md);
            font-size: 16px; transition: 0.3s; box-sizing: border-box; background: #fafafa;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); background: #fff; }

        .btn-maps, .btn-gps {
            padding: 10px 15px; font-size: 12px; border-radius: 8px; cursor: pointer;
            display: block; margin-bottom: 8px; font-weight: 600; width: 100%; text-align: center;
        }
        .btn-maps { background-color: #fff; color: #1976d2; border: 1px solid #1976d2; }
        .btn-gps { background-color: #e8f5e9; color: var(--primary-color); border: 1px dashed var(--primary-color); }

        /* Style Modal Peta */
        #map-container { height: 250px; width: 100%; border-radius: var(--radius-md); margin-bottom: 15px; border: 2px solid #eee; }

        .total-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white; padding: 20px; border-radius: var(--radius-md); text-align: center;
        }
        .total-row { display: flex; justify-content: space-between; width: 100%; }
        #total-display { font-size: 24px; font-weight: 700; }
        #promo-display { font-size: 12px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 8px; margin-top: 5px; display: none; }

        #btn-submit {
            width: 100%; padding: 16px; margin-top: 20px; background-color: var(--text-dark);
            color: white; border: none; border-radius: var(--radius-md); font-size: 16px;
            font-weight: 700; cursor: pointer; display: block;
        }

        #qris-section { text-align: center; background: #f0f4f0; padding: 15px; border-radius: var(--radius-md); border: 2px dashed var(--primary-color); margin-bottom: 15px; }
        #qris-image { width: 200px; height: 200px; margin: 10px auto; background: #ccc; display: block; }

        .hidden { display: none; }
        .success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; visibility: hidden; opacity: 0; transition: 0.4s; }
        .success-overlay.active { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="jelly-mascot-container"><div class="coconut-jelly"></div></div>
        <h2>Coconut Bumi Jelly D'Hasna</h2>
        <div class="subtitle">Segar Alami, Nikmat Tiada Henti</div>
    </header>

    <form id="orderForm">
        <div class="form-group">
            <label>Nama Pemesan</label>
            <input type="text" id="nama" placeholder="Masukkan nama Anda" required>
        </div>

        <div class="form-group">
            <label>Alamat Lengkap</label>
            <textarea id="alamat" rows="2" placeholder="Jalan, Nomor, Patokan..." required></textarea>
        </div>

        <div class="form-group">
            <label>Penentuan Lokasi & Jarak</label>
            <button type="button" id="btn-gps" class="btn-gps">üì° Deteksi Lokasi Saya (GPS)</button>
            <div id="gps-status" style="font-size: 11px; text-align: center; color: #666; margin-bottom: 5px;"></div>
            <div id="map-container" class="hidden"></div>
            <button type="button" id="btn-toggle-map" class="btn-maps">üó∫Ô∏è Pilih Manual di Peta</button>
            <input type="number" id="jarak" step="0.1" min="0" placeholder="Jarak (KM)" required readonly>
        </div>

        <div class="form-group">
            <label>Jumlah Pesanan (Butir)</label>
            <input type="number" id="jumlah" min="1" value="1" required>
        </div>

        <div class="form-group">
            <label>Metode Pembayaran</label>
            <select id="pembayaran">
                <option value="Cash">Cash (Tunai)</option>
                <option value="QRIS">QRIS / Transfer</option>
            </select>
        </div>

        <div id="qris-flow" class="hidden">
            <button type="button" id="btn-show-qris" style="width:100%; padding:10px; background:#1976d2; color:#fff; border:none; border-radius:8px; margin-bottom:10px;">Tampilkan Kode QRIS</button>
            
            <div id="qris-section" class="hidden">
                <p style="font-size:12px; margin:0;">Silakan Scan QRIS Berikut:</p>
                <img id="qris-image" src="https://via.placeholder.com/200?text=QRIS+CODE" alt="QRIS D'Hasna">
                <p style="font-size:11px; color:#d32f2f;">Setelah bayar, upload bukti di bawah:</p>
                <input type="file" id="bukti_file" accept="image/*">
            </div>
        </div>

        <div class="total-box">
            <div class="total-row"><span>Total Bayar</span><span id="total-display">Rp 15.000</span></div>
            <div id="promo-display"></div>
        </div>

        <button type="submit" id="btn-submit">KIRIM PESANAN SEKARANG</button>
    </form>
</div>

<div class="success-overlay" id="successPopup">
    <div class="success-card"><h3>Pesanan Berhasil!</h3><p>Mengalihkan ke WhatsApp...</p></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORE_LAT = -6.369596; const STORE_LNG = 107.400326;
        const SUPABASE_URL = "https://iltvpnplysjeaxufiokg.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU";
        
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let map, marker;
        const inputJarak = document.getElementById('jarak');
        const inputJumlah = document.getElementById('jumlah');
        const displayTotal = document.getElementById('total-display');
        const displayPromo = document.getElementById('promo-display');
        const btnSubmit = document.getElementById('btn-submit');

        // --- Logika Peta Leaflet ---
        function initMap(lat, lng) {
            document.getElementById('map-container').classList.remove('hidden');
            if (!map) {
                map = L.map('map-container').setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                marker.on('dragend', function(e) {
                    updateDistance(e.target.getLatLng().lat, e.target.getLatLng().lng);
                });
            } else {
                map.setView([lat, lng], 13);
                marker.setLatLng([lat, lng]);
            }
            updateDistance(lat, lng);
        }

        async function updateDistance(lat, lng) {
            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${STORE_LNG},${STORE_LAT};${lng},${lat}?overview=false`;
            try {
                const res = await fetch(osrmUrl);
                const data = await res.json();
                if (data.code === "Ok") {
                    inputJarak.value = (data.routes[0].distance / 1000).toFixed(1);
                    hitungTotal();
                }
            } catch (e) { console.error("OSRM Error"); }
        }

        document.getElementById('btn-toggle-map').addEventListener('click', () => initMap(STORE_LAT, STORE_LNG));
        
        document.getElementById('btn-gps').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => initMap(p.coords.latitude, p.coords.longitude));
            }
        });

        // --- Logika Pembayaran QRIS ---
        document.getElementById('pembayaran').addEventListener('change', function() {
            const qrisFlow = document.getElementById('qris-flow');
            if (this.value === 'QRIS') {
                qrisFlow.classList.remove('hidden');
                btnSubmit.classList.add('hidden');
            } else {
                qrisFlow.classList.add('hidden');
                btnSubmit.classList.remove('hidden');
            }
        });

        document.getElementById('btn-show-qris').addEventListener('click', function() {
            document.getElementById('qris-section').classList.remove('hidden');
            this.classList.add('hidden');
        });

        document.getElementById('bukti_file').addEventListener('change', function() {
            if (this.files.length > 0) btnSubmit.classList.remove('hidden');
        });

        // --- Logika Diskon & Total (Sesuai Aturan Anda) ---
        function hitungTotal() {
            const jml = parseInt(inputJumlah.value) || 0;
            const km = parseFloat(inputJarak.value) || 0;
            const hrg = 15000;
            let ongkir = km > 4 ? Math.ceil(km - 4) * 1000 : 0;
            let promo = "";

            if (jml > 5 && km <= 25) { ongkir = 0; promo = "Gratis Ongkir (Order >5)"; }
            else if (jml > 4 && km >= 20) { ongkir *= 0.5; promo = "Diskon Ongkir 50% (Order >4)"; }
            else if (jml >= 3 && km <= 15) { ongkir = 0; promo = "Gratis Ongkir (Order 3+)"; }
            else if (jml >= 2 && km <= 15) { ongkir *= 0.5; promo = "Diskon Ongkir 50% (Order 2+)"; }

            displayTotal.innerText = `Rp ${(jml * hrg + ongkir).toLocaleString('id-ID')}`;
            if (promo) { displayPromo.innerText = promo; displayPromo.style.display = "block"; }
            else displayPromo.style.display = "none";
        }

        inputJumlah.addEventListener('input', hitungTotal);

        // --- Submit ---
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            btnSubmit.disabled = true;
            try {
                const nama = document.getElementById('nama').value;
                const fileInput = document.getElementById('bukti_file');
                let buktiUrl = "";

                if (document.getElementById('pembayaran').value === 'QRIS') {
                    const file = fileInput.files[0];
                    const fileName = `bukti-${Date.now()}.jpg`;
                    const { data, error } = await db.storage.from('bukti-transfer').upload(fileName, file);
                    if (error) throw error;
                    const { data: url } = db.storage.from('bukti-transfer').getPublicUrl(fileName);
                    buktiUrl = url.publicUrl;
                }

                // Simpan ke Supabase DB
                await db.from('orders').insert([{
                    nama, 
                    alamat: document.getElementById('alamat').value,
                    jarak_km: inputJarak.value,
                    jumlah_butir: jml,
                    metode_bayar: document.getElementById('pembayaran').value,
                    total_bayar: displayTotal.innerText,
                    bukti_url: buktiUrl
                }]);

                document.getElementById('successPopup').classList.add('active');
                setTimeout(() => {
                    const pesan = `Halo Admin, saya pesan Coconut Jelly.\nNama: ${nama}\nTotal: ${displayTotal.innerText}\nBukti: ${buktiUrl || 'Cash'}`;
                    window.open(`https://wa.me/62895336907868?text=${encodeURIComponent(pesan)}`, '_blank');
                    window.location.reload();
                }, 2000);
            } catch (err) { alert("Error: " + err.message); btnSubmit.disabled = false; }
        });
    });
</script>
</body>
</html>
