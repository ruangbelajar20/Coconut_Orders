<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order Coconut Bumi Jelly D'Hasna</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary-color: #2e7d32; --accent-color: #81c784; --bg-color: #f7f9fc; 
            --card-bg: #ffffff; --text-dark: #333333; --text-muted: #777777;
            --shadow-soft: 0 10px 30px -10px rgba(46, 125, 50, 0.1);
            --radius-xl: 24px; --radius-md: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-color);
            margin: 0; padding: 20px; display: flex; justify-content: center;
            align-items: center; min-height: 100vh; color: var(--text-dark);
            user-select: none; -webkit-user-select: none;
        }

        .container {
            background: var(--card-bg); width: 100%; max-width: 480px;
            padding: 40px 30px; border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft); position: relative; overflow: hidden;
        }

        header { text-align: center; margin-bottom: 30px; }
        .jelly-mascot-container { height: 80px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .coconut-jelly {
            width: 70px; height: 60px; background: linear-gradient(to bottom, #ffffff 40%, #e0e0e0 100%);
            border-radius: 50% 50% 40% 40% / 60% 60% 35% 35%; border: 4px solid #6d4c41;
            position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: floatJelly 3s ease-in-out infinite;
        }
        @keyframes floatJelly { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-8px) scale(1.02); } }

        h2 { color: var(--primary-color); font-weight: 700; margin: 0; font-size: 22px; }
        .subtitle { color: var(--text-muted); font-size: 14px; margin-top: 5px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; font-size: 13px; color: var(--text-dark); margin-bottom: 8px; }

        input, textarea, select {
            width: 100%; padding: 14px 16px; border: 2px solid #eee; border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif; font-size: 16px; transition: all 0.3s ease;
            box-sizing: border-box; background: #fafafa;
        }

        .btn-maps, .btn-gps {
            padding: 10px 15px; font-size: 12px; border-radius: 8px; cursor: pointer;
            display: block; margin-bottom: 8px; font-weight: 600; width: 100%; text-align: center;
        }
        .btn-maps { background-color: #fff; color: #1976d2; border: 1px solid #1976d2; }
        .btn-gps { background-color: #e8f5e9; color: var(--primary-color); border: 1px dashed var(--primary-color); }

        .total-box {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white; padding: 20px; border-radius: var(--radius-md); margin-top: 30px;
        }
        #total-display { font-size: 24px; font-weight: 700; }
        #promo-display { font-size: 12px; margin-top: 5px; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 5px; }

        /* Modal Map Styles */
        #map-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #map-container { width: 90%; height: 70%; background: white; border-radius: 15px; overflow: hidden; position: relative; }
        #leaflet-map { width: 100%; height: 100%; }
        .map-controls { margin-top: 15px; width: 90%; display: flex; gap: 10px; }

        /* QRIS Area Styles */
        #qris-display-area {
            text-align: center; background: #fff; padding: 15px; border-radius: 15px;
            border: 2px solid var(--accent-color); margin-top: 15px;
        }
        .qris-image { width: 200px; height: auto; border-radius: 10px; margin: 10px 0; }
        
        #btn-submit {
            width: 100%; padding: 16px; margin-top: 20px; background-color: var(--text-dark);
            color: white; border: none; border-radius: var(--radius-md); font-weight: 700; cursor: pointer;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="jelly-mascot-container"><div class="coconut-jelly"></div></div>
        <h2>Coconut Bumi Jelly D'Hasna</h2>
        <div class="subtitle">Segar Alami, Nikmat Tiada Henti</div>
    </header>

    <form id="orderForm">
        <div class="form-group">
            <label>Nama Pemesan</label>
            <input type="text" id="nama" placeholder="Masukkan nama Anda" required>
        </div>

        <div class="form-group">
            <label>Alamat Lengkap</label>
            <textarea id="alamat" rows="2" placeholder="Jalan, Nomor, Patokan..." required></textarea>
        </div>

        <div class="form-group">
            <label>Jarak dari Toko (KM)</label>
            <button type="button" id="btn-gps" class="btn-gps">üì° Deteksi Lokasi Saya (GPS)</button>
            <button type="button" id="btn-maps-manual" class="btn-maps">üìç Pilih Lokasi di Peta (Manual)</button>
            <div id="gps-status" style="font-size: 11px; text-align: center; margin-bottom: 5px;"></div>
            <input type="number" id="jarak" step="0.1" min="0" placeholder="Hasil jarak rute otomatis" required>
        </div>

        <div class="form-group">
            <label>Jumlah Pesanan (Butir)</label>
            <input type="number" id="jumlah" min="1" value="1" required>
        </div>

        <div class="form-group">
            <label>Metode Pembayaran</label>
            <select id="pembayaran">
                <option value="Cash">Cash (Tunai)</option>
                <option value="QRIS">QRIS / Transfer Bank</option>
            </select>
        </div>

        <div id="qris-interaction" class="hidden">
            <button type="button" id="btn-show-qris" class="btn-maps" style="background: var(--accent-color); color: white; border:none;">
                üì± Tampilkan QRIS Pembayaran
            </button>
            
            <div id="qris-display-area" class="hidden">
                <p style="font-size: 12px; font-weight: bold; margin: 0;">Scan Kode QRIS di Bawah:</p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=COCONUT_BUMI_JELLY_HASNA" alt="QRIS" class="qris-image">
                <p style="font-size: 11px; color: var(--text-muted);">Silakan bayar sesuai total, lalu upload bukti di bawah.</p>
                
                <div id="area-upload" class="form-group">
                    <label style="color: #d32f2f;">Upload Bukti Transfer (Wajib):</label>
                    <input type="file" id="bukti_file" accept="image/*">
                </div>
            </div>
        </div>

        <div class="total-box">
            <div style="display: flex; justify-content: space-between; width: 100%;">
                <span>Total Bayar</span>
                <span id="total-display">Rp 15.000</span>
            </div>
            <div id="promo-display" class="hidden"></div>
        </div>

        <button type="submit" id="btn-submit">KIRIM PESANAN SEKARANG</button>
    </form>
</div>

<div id="map-modal">
    <div id="map-container">
        <div id="leaflet-map"></div>
    </div>
    <div class="map-controls">
        <button type="button" id="btn-confirm-loc" class="btn-gps" style="margin:0;">‚úÖ Konfirmasi Lokasi</button>
        <button type="button" id="btn-close-map" class="btn-maps" style="margin:0; background:#f44336; color:white; border:none;">Batal</button>
    </div>
</div>

<div class="success-overlay" id="successPopup">
    <div class="success-card">
        <div class="pulse-icon">‚úì</div>
        <h3>Pesanan Berhasil!</h3>
        <p>Terima kasih telah memesan.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORE_LAT = -6.369596, STORE_LNG = 107.400326;
        const SUPABASE_URL = "https://iltvpnplysjeaxufiokg.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU";
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Map Variables
        let lMap, marker;
        const modal = document.getElementById('map-modal');

        // Logic Elements
        const form = document.getElementById('orderForm');
        const inputJarak = document.getElementById('jarak');
        const inputJumlah = document.getElementById('jumlah');
        const selectBayar = document.getElementById('pembayaran');
        const qrisSection = document.getElementById('qris-interaction');
        const qrisContent = document.getElementById('qris-display-area');
        const btnSubmit = document.getElementById('btn-submit');

        // --- MAP FUNCTIONS ---
        document.getElementById('btn-maps-manual').addEventListener('click', () => {
            modal.style.display = 'flex';
            if (!lMap) {
                lMap = L.map('leaflet-map').setView([STORE_LAT, STORE_LNG], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(lMap);
                marker = L.marker([STORE_LAT, STORE_LNG], { draggable: true }).addTo(lMap);
            }
        });

        document.getElementById('btn-close-map').addEventListener('click', () => modal.style.display = 'none');

        document.getElementById('btn-confirm-loc').addEventListener('click', async () => {
            const pos = marker.getLatLng();
            modal.style.display = 'none';
            await getRoute(pos.lat, pos.lng);
        });

        // --- GPS & ROUTE FUNCTIONS ---
        document.getElementById('btn-gps').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => getRoute(p.coords.latitude, p.coords.longitude));
            }
        });

        async function getRoute(lat, lng) {
            const url = `https://router.project-osrm.org/route/v1/driving/${STORE_LNG},${STORE_LAT};${lng},${lat}?overview=false`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.code === "Ok") {
                    inputJarak.value = (data.routes[0].distance / 1000).toFixed(1);
                    hitungTotal();
                }
            } catch (e) { alert("Gagal mengambil rute"); }
        }

        // --- PRICING LOGIC ---
        function hitungTotal() {
            const jumlah = parseInt(inputJumlah.value) || 0, jarak = parseFloat(inputJarak.value) || 0;
            let ongkir = jarak > 4 ? Math.ceil(jarak - 4) * 1000 : 0;
            let promo = "";

            if (jumlah > 5 && jarak <= 25) { ongkir = 0; promo = "üéâ Promo: >5 Butir Gratis Ongkir (Maks 25km)"; }
            else if (jumlah > 4 && jarak >= 20) { ongkir *= 0.5; promo = "üî• Promo: >4 Butir Diskon Ongkir 50% (>20km)"; }
            else if (jumlah >= 3 && jarak <= 15) { ongkir = 0; promo = "üéâ Promo: 3+ Butir Gratis Ongkir (Maks 15km)"; }
            else if (jumlah >= 2 && jarak <= 15) { ongkir *= 0.5; promo = "‚ú® Promo: 2+ Butir Diskon Ongkir 50% (Maks 15km)"; }

            const total = (jumlah * 15000) + ongkir;
            document.getElementById('total-display').innerText = "Rp " + total.toLocaleString('id-ID');
            const pBox = document.getElementById('promo-display');
            if (promo) { pBox.innerText = promo; pBox.classList.remove('hidden'); }
            else { pBox.classList.add('hidden'); }
        }

        inputJumlah.addEventListener('input', hitungTotal);
        inputJarak.addEventListener('input', hitungTotal);

        // --- PAYMENT LOGIC ---
        selectBayar.addEventListener('change', (e) => {
            if (e.target.value === 'QRIS') {
                qrisSection.classList.remove('hidden');
                btnSubmit.classList.add('hidden');
            } else {
                qrisSection.classList.add('hidden');
                qrisContent.classList.add('hidden');
                btnSubmit.classList.remove('hidden');
            }
        });

        document.getElementById('btn-show-qris').addEventListener('click', () => {
            qrisContent.classList.remove('hidden');
            btnSubmit.classList.remove('hidden');
        });

        // --- SUBMIT LOGIC ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            btnSubmit.disabled = true;
            btnSubmit.innerText = "‚è≥ Mengirim...";

            try {
                const fileInput = document.getElementById('bukti_file');
                let buktiUrl = "";

                if (selectBayar.value === 'QRIS' && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const fName = `bukti-${Date.now()}.jpg`;
                    const { error } = await db.storage.from('bukti-transfer').upload(fName, file);
                    if (error) throw error;
                    const { data } = db.storage.from('bukti-transfer').getPublicUrl(fName);
                    buktiUrl = data.publicUrl;
                }

                const { error } = await db.from('orders').insert([{
                    nama: document.getElementById('nama').value,
                    alamat: document.getElementById('alamat').value,
                    jarak: inputJarak.value,
                    jumlah: inputJumlah.value,
                    total: document.getElementById('total-display').innerText,
                    pembayaran: selectBayar.value,
                    bukti_transfer: buktiUrl
                }]);

                if (error) throw error;
                document.getElementById('successPopup').classList.add('active');
                setTimeout(() => window.location.reload(), 3000);
            } catch (err) {
                alert("Gagal: " + err.message);
                btnSubmit.disabled = false;
                btnSubmit.innerText = "KIRIM PESANAN SEKARANG";
            }
        });
    });
</script>

</body>
</html>
