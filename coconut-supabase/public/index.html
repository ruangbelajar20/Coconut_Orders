<script>
    // --- 1. SETTING SUPABASE ---
    const SUPABASE_URL = "https://iltvpnplysjeaxufiokg.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdHZwbnBseXNqZWF4dWZpb2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODAyMDQsImV4cCI6MjA4Njg1NjIwNH0.O3LvaTPu-avo8Ctrq6fX0xQlZilO26JCKaYE5Y9SqUU";

    // PERBAIKAN: Ganti nama variabel 'supabase' jadi 'db' agar tidak bentrok
    let db; 
    
    try {
        // Kita panggil window.supabase (Pabriknya) untuk membuat client (db)
        db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Database berhasil terhubung");
    } catch (err) {
        console.error("Error Koneksi:", err);
    }

    // --- 2. LOGIKA HITUNG HARGA ---
    const inputJarak = document.getElementById('jarak');
    const inputJumlah = document.getElementById('jumlah');
    const inputPembayaran = document.getElementById('pembayaran');
    const displayTotal = document.getElementById('total-display');
    const areaUpload = document.getElementById('area-upload');

    // Fungsi ini sekarang akan terbaca karena error di atas sudah hilang
    function hitungTotal() {
        const jumlah = parseFloat(inputJumlah.value) || 0;
        const jarak = parseFloat(inputJarak.value) || 0;
        
        const HARGA_PER_BUTIR = 15000;
        const JARAK_DASAR = 4; 
        const ONGKIR_PER_KM = 1000;

        let total = jumlah * HARGA_PER_BUTIR;

        if (jarak > JARAK_DASAR) {
            let kelebihan = Math.ceil(jarak - JARAK_DASAR); 
            total += (kelebihan * ONGKIR_PER_KM);
        }

        displayTotal.innerText = "Rp " + total.toLocaleString('id-ID');
    }

    function cekMetode() {
        if (inputPembayaran.value === 'QRIS') {
            areaUpload.style.display = 'block';
        } else {
            areaUpload.style.display = 'none';
        }
    }

    // Event Listeners
    if(inputJarak) inputJarak.addEventListener('input', hitungTotal);
    if(inputJumlah) inputJumlah.addEventListener('input', hitungTotal);
    if(inputPembayaran) inputPembayaran.addEventListener('change', cekMetode);


    // --- 3. PROSES KIRIM ---
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('btn-submit');
        const originalText = btn.innerText;
        btn.innerText = "Sedang Mengirim...";
        btn.disabled = true;

        try {
            const nama = document.getElementById('nama').value;
            const alamat = document.getElementById('alamat').value;
            const jarak = document.getElementById('jarak').value;
            const jumlah = document.getElementById('jumlah').value;
            const metode = document.getElementById('pembayaran').value;
            const fileInput = document.getElementById('bukti_file');
            
            let buktiUrl = "";

            if (metode === 'QRIS') {
                if (fileInput.files.length === 0) throw new Error("Wajib upload bukti transfer!");
                
                const file = fileInput.files[0];
                const fileName = `bukti-${Date.now()}.jpg`;
                
                // PERBAIKAN: Gunakan 'db' bukan 'supabase'
                const { data, error } = await db.storage
                    .from('bukti-transfer')
                    .upload(fileName, file);

                if (error) throw error;

                const { data: urlData } = db.storage
                    .from('bukti-transfer')
                    .getPublicUrl(fileName);
                
                buktiUrl = urlData.publicUrl;
            }

            // Kirim ke Backend
            const response = await fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nama, alamat, jarak, jumlah, metode, buktiUrl })
            });

            if (!response.ok) throw new Error("Gagal menyimpan ke database");

            alert("Pesanan Berhasil!");
            const pesanWA = `Halo, saya order. Nama: ${nama}. Total: ${displayTotal.innerText}`;
            window.open(`https://wa.me/6281234567890?text=${encodeURIComponent(pesanWA)}`, '_blank');
            location.reload();

        } catch (err) {
            alert("Error: " + err.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });
</script>
